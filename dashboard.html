<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>DRF Wallet Dashboard</title>
    <link rel="stylesheet" href="style.css"/>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  </head>

  <body style="font-family: Arial; background: #f4f9fb; padding: 20px;">
    <!-- Dashboard Content -->
    <div class="card-container">
      <div class="card three-d-effect" id="drfCard" style="max-width: 400px; margin: 20px auto; padding: 20px; background: #fff; border-radius: 10px;">
        <img src="https://ik.imagekit.io/ttbbg9ocv/1000000655.jpg" alt="DRF Logo" style="max-width: 100px; display: block; margin: 0 auto 15px auto;"/>
        <h3 style="text-align:center;">DigiTal Rufiya Wallet Binance Smart Chain Network</h3>
        <p class="balance" id="drfBalance" style="font-size: 18px; text-align:center; margin-top: 10px;"></p>
      </div>
    </div>

    <header style="display: flex; justify-content: space-between; align-items: center; max-width: 400px; margin: auto;">
      <a href="settings.html" style="font-size: 14px; text-decoration: none;">‚öôÔ∏è Settings</a>
    </header>

    <div style="max-width: 400px; margin: 10px auto;">
      <h3>Total Portfolio Value: <span id="totalValue">0.00</span> USD</h3>
      <p id="walletAddress" style="font-weight: bold; word-break: break-all;"></p>
    </div>

    <div style="max-width: 400px; margin: auto; padding: 20px; background: #fff; border-radius: 10px;">
      <h3>Balances</h3>
      <p>DRF: <span id="drfBalanceToken">0</span> (<small id="drfPrice">‚Äî</small> USD)</p>
      <p>USDC: <span id="usdcBalance">0</span> (<small id="usdcPrice">‚Äî</small> USD)</p>
      <p>USDT: <span id="usdtBalance">0</span> (<small id="usdtPrice">‚Äî</small> USD)</p>
    </div>

    <!-- ü™ô RECEIVE SECTION -->
    <h3 style="margin-top: 30px; max-width: 400px; margin-left: auto; margin-right: auto;">üîê Receive Tokens</h3>
    <div id="receiveSection" style="max-width: 420px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 12px;">
      <label for="token-select">Select Token:</label>
      <select id="token-select" onchange="updateReceiveDisplay()" style="width: 100%; padding: 10px; margin-bottom: 15px;">
        <option value="DRF">DRF</option>
        <option value="BNB">BNB</option>
        <option value="USDT">USDT</option>
        <option value="USDC">USDC</option>
      </select>

      <div id="qr-container" style="margin: 20px auto; text-align: center;"></div>

      <p>Wallet Address:</p>
      <input type="text" id="wallet-address-display" readonly style="width: 100%; padding: 10px;" />
      
      <div style="margin-top: 10px; display: flex; align-items: center;">
        <button onclick="copyWalletAddress()" style="padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 5px;">üìã Copy Address</button>
        <a id="bscscan-link" href="#" target="_blank" style="margin-left: 15px; font-size: 14px; word-break: break-all;">üîó View on BscScan</a>
      </div>
    </div>

    <!-- Sell DRF -->
    <div style="margin-top: 30px; max-width: 400px; margin-left: auto; margin-right: auto;">
      <button onclick="sellDRF()" style="padding: 10px 20px; background-color: #007bff; color: white; width: 100%;">Sell DRF to Mainnet</button>
    </div>

    <!-- Affiliate -->
    <div style="margin-top: 20px; max-width: 400px; margin-left: auto; margin-right: auto;">
      <button onclick="shareAffiliateLink()" style="padding: 10px 20px; background-color: #28a745; color: white; width: 100%;">Earn by Promoting</button>
    </div>

    <!-- FOOTER NAV -->
    <div class="bottom-nav" style="position: fixed; bottom: 0; width: 100%; background: #fff; display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #ccc;">
      <a href="dashboard.html" style="text-align:center; font-size: 12px;">
        <img src="icon/dashboard.png" alt="Dashboard" width="24" /><br>Dashboard
      </a>
      <a href="send.html" style="text-align:center; font-size: 12px;">
        <img src="icon/send.png" alt="Send" width="24" /><br>Send
      </a>
      <a href="swap.html" style="text-align:center; font-size: 12px;">
        <img src="icon/swap.png" alt="Swap" width="24" /><br>Swap
      </a>
      <a href="transactions.html" style="text-align:center; font-size: 12px;">
        <img src="icon/transactions.png" alt="Transactions" width="24" /><br>Transactions
      </a>
      <a href="tokensale.html" style="text-align:center; font-size: 12px;">
        <img src="icon/token.png" alt="Token" width="24" /><br>Token
      </a>
    </div>

    <footer style="text-align: center; margin-top: 60px; margin-bottom: 20px;">
      <p>2025 ¬© DRF Wallet powered by AI technology and ChatGPT</p>
    </footer>

    <script>
      const DRF_ADDRESS = "0x7788a60dbC85AB46767F413EC7d51F149AA1bec6";
      const USDT_ADDRESS = "0x55d398326f99059fF775485246999027B3197955";
      const USDC_ADDRESS = "0x8ac76a51cc950d9822d68b83fe1ad97b32cd580d";

      const API_KEY = "G9H3FIK6M6EREF9DENVXG9EXHAVJJCXFM8";

      const BSC_RPC_URL = "https://bsc-dataseed.binance.org/";

      let userWallet;

      async function setupWalletIfNeeded() {
        if (!localStorage.getItem("drf_encrypted_wallet")) {
          const wallet = ethers.Wallet.createRandom();
          const password = prompt("Create a password to encrypt your new wallet:");
          if (!password) {
            alert("Password is required to create wallet.");
            return;
          }
          const encryptedJson = await wallet.encrypt(password);

          localStorage.setItem("drf_encrypted_wallet", encryptedJson);
          localStorage.setItem("isLoggedIn", "true");

          alert("Wallet created successfully. Please remember your password.");
        }
      }

      async function initializeWallet() {
        if (!localStorage.getItem("isLoggedIn")) {
          alert("Please log in first.");
          return window.location.href = "index.html";
        }

        const encryptedWallet = localStorage.getItem("drf_encrypted_wallet");
        const password = prompt("Enter password to unlock wallet:");
        if (!password) {
          alert("Password is required.");
          return window.location.href = "index.html";
        }

        try {
          userWallet = await ethers.Wallet.fromEncryptedJson(encryptedWallet, password);
          fetchBalances();
          fetchTokenPrices();

          // Display wallet info
          document.getElementById("wallet-address-display").value = userWallet.address;
          document.getElementById("walletAddress").textContent = `Your Wallet: ${userWallet.address}`;
          document.getElementById("bscscan-link").href = `https://bscscan.com/address/${userWallet.address}`;

          generateQRCode(userWallet.address, "DRF");

        } catch (err) {
          alert("Failed to load wallet. Please try again.");
          console.error(err);
        }
      }

      async function fetchBalances() {
        try {
          const provider = new ethers.providers.JsonRpcProvider(BSC_RPC_URL);

          const drfToken = new ethers.Contract(DRF_ADDRESS, ["function balanceOf(address) view returns (uint256)", "function decimals() view returns (uint8)"], provider);
          const usdtToken = new ethers.Contract(USDT_ADDRESS, ["function balanceOf(address) view returns (uint256)", "function decimals() view returns (uint8)"], provider);
          const usdcToken = new ethers.Contract(USDC_ADDRESS, ["function balanceOf(address) view returns (uint256)", "function decimals() view returns (uint8)"], provider);

          const [drfBalanceRaw, usdtBalanceRaw, usdcBalanceRaw, drfDecimals, usdtDecimals, usdcDecimals] = await Promise.all([
            drfToken.balanceOf(userWallet.address),
            usdtToken.balanceOf(userWallet.address),
            usdcToken.balanceOf(userWallet.address),
            drfToken.decimals(),
            usdtToken.decimals(),
            usdcToken.decimals(),
          ]);

          const drfBalance = ethers.utils.formatUnits(drfBalanceRaw, drfDecimals);
          const usdtBalance = ethers.utils.formatUnits(usdtBalanceRaw, usdtDecimals);
          const usdcBalance = ethers.utils.formatUnits(usdcBalanceRaw, usdcDecimals);

          document.getElementById("drfBalanceToken").textContent = `${drfBalance} DRF`;
          document.getElementById("usdtBalance").textContent = `${usdtBalance} USDT`;
          document.getElementById("usdcBalance").textContent = `${usdcBalance} USDC`;

          updatePortfolioValue(drfBalance, usdtBalance, usdcBalance);

        } catch (error) {
          console.error("Error fetching balances:", error);
        }
      }

      async function fetchTokenPrices() {
        // Using BscScan API or alternative price API to get USD price - here a mock example with CoinGecko as BscScan doesn't provide direct price API

        // CoinGecko IDs for tokens
        const tokens = {
          DRF: "digital-rufiya",
          USDT: "tether",
          USDC: "usd-coin"
        };

        try {
          // Fetch prices from CoinGecko
          const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${tokens.DRF},${tokens.USDT},${tokens.USDC}&vs_currencies=usd`);
          const data = await response.json();

          // Update price displays
          document.getElementById("drfPrice").textContent = `$${data[tokens.DRF]?.usd ?? '0.00'}`;
          document.getElementById("usdtPrice").textContent = `$${data[tokens.USDT]?.usd ?? '0.00'}`;
          document.getElementById("usdcPrice").textContent = `$${data[tokens.USDC]?.usd ?? '0.00'}`;

          // Recalculate portfolio value with updated prices
          const drfBalanceText = document.getElementById("drfBalanceToken").textContent.split(" ")[0];
          const usdtBalanceText = document.getElementById("usdtBalance").textContent.split(" ")[0];
          const usdcBalanceText = document.getElementById("usdcBalance").textContent.split(" ")[0];

          updatePortfolioValue(parseFloat(drfBalanceText), parseFloat(usdtBalanceText), parseFloat(usdcBalanceText), data);

        } catch (error) {
          console.error("Error fetching prices:", error);
        }
      }

      function updatePortfolioValue(drfBal, usdtBal, usdcBal, prices = null) {
        // If prices not passed, fallback to current DOM values
        if (!prices) {
          prices = {
            "digital-rufiya": { usd: parseFloat(document.getElementById("drfPrice").textContent.replace("$","")) || 0 },
            tether: { usd: parseFloat(document.getElementById("usdtPrice").textContent.replace("$","")) || 0 },
            "usd-coin": { usd: parseFloat(document.getElementById("usdcPrice").textContent.replace("$","")) || 0 }
          };
        }

        const drfPriceUsd = prices["digital-rufiya"]?.usd || 0;
        const usdtPriceUsd = prices["tether"]?.usd || 0;
        const usdcPriceUsd = prices["usd-coin"]?.usd || 0;

        const totalValue = (drfBal * drfPriceUsd) + (usdtBal * usdtPriceUsd) + (usdcBal * usdcPriceUsd);

        document.getElementById("totalValue").textContent = totalValue.toFixed(2);
      }

      function generateQRCode(address, token) {
        const qrContainer = document.getElementById("qr-container");
        qrContainer.innerHTML = "";
        const qrText = token === "BNB"
          ? `binance:${address}`
          : `${token.toLowerCase()}:${address}`;
        QRCode.toCanvas(qrText, { width: 200, margin: 2 }, function (error, canvas) {
          if (error) {
            console.error(error);
            qrContainer.textContent = "Failed to generate QR code.";
            return;
          }
          qrContainer.appendChild(canvas);
        });
      }

      function updateReceiveDisplay() {
        const tokenSelect = document.getElementById("token-select");
        const selectedToken = tokenSelect.value;
        const addressInput = document.getElementById("wallet-address-display");
        addressInput.value = userWallet.address;

        generateQRCode(userWallet.address, selectedToken);

        // Update BscScan link based on selected token
        let link = "";
        if (selectedToken === "DRF") {
          link = `https://bscscan.com/token/${DRF_ADDRESS}?a=${userWallet.address}`;
        } else if (selectedToken === "USDT") {
          link = `https://bscscan.com/token/${USDT_ADDRESS}?a=${userWallet.address}`;
        } else if (selectedToken === "USDC") {
          link = `https://bscscan.com/token/${USDC_ADDRESS}?a=${userWallet.address}`;
        } else {
          link = `https://bscscan.com/address/${userWallet.address}`;
        }
        document.getElementById("bscscan-link").href = link;
      }

      function copyWalletAddress() {
        const addressInput = document.getElementById("wallet-address-display");
        addressInput.select();
        addressInput.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(addressInput.value).then(() => {
          alert("Wallet address copied to clipboard!");
        }).catch(err => {
          alert("Failed to copy: " + err);
        });
      }

      function sellDRF() {
        alert("Sell DRF feature coming soon!");
      }

      function shareAffiliateLink() {
        const affiliateUrl = `https://drfwallet.com/?ref=${userWallet.address}`;
        navigator.clipboard.writeText(affiliateUrl).then(() => {
          alert("Affiliate link copied to clipboard:\n" + affiliateUrl);
        });
      }

      // On page load
      window.onload = async () => {
        await setupWalletIfNeeded();
        await initializeWallet();
      };
    </script>

  </body>
</html>
