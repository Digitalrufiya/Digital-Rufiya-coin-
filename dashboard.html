<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DRF Wallet Pro Dashboard</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
</head>
<body style="font-family: Arial; background: #f4f9fb; padding: 20px;">
  <h2>DRF Wallet (Pro Version)</h2>
  <div id="networkStatus" style="margin-bottom: 10px; color: green; font-weight: bold;">Connecting to BSC...</div>

  <div>
    <h3>Total Portfolio Value: <span id="totalValue">0.00</span> USD</h3>
    <p id="walletAddress" style="font-weight: bold;"></p>
  </div>

  <div style="max-width: 400px; margin: auto; padding: 20px; background: #fff; border-radius: 10px;">
    <h3>Balances</h3>
    <p>BNB: <span id="bnbBalance">0</span> (<small id="bnbPrice">—</small> USD)</p>
    <p>DRF: <span id="drfBalance">0</span> (<small id="drfPrice">Price unavailable</small>)</p>
    <p>USDC: <span id="usdcBalance">0</span> (<small id="usdcPrice">—</small> USD)</p>
    <p>USDT: <span id="usdtBalance">0</span> (<small id="usdtPrice">—</small> USD)</p>
  </div>

  <script>
    const BSC_RPC_URL = "https://bsc-dataseed.binance.org/";
    const DRF_ADDRESS = "0x7788a60dbC85AB46767F413EC7d51F149AA1bec6";
    const USDT_ADDRESS = "your_usdt_address_here";
    const USDC_ADDRESS = "your_usdc_address_here";

    let userWallet;
    const provider = new ethers.providers.JsonRpcProvider(BSC_RPC_URL);

    async function initializeWallet() {
      if (!localStorage.getItem("isLoggedIn")) {
        alert("Please log in first.");
        window.location.href = "index.html";
        return;
      }

      const encryptedWallet = localStorage.getItem("drf_encrypted_wallet");
      const password = prompt("Enter password to unlock wallet:");

      try {
        userWallet = await ethers.Wallet.fromEncryptedJson(encryptedWallet, password);
        userWallet = userWallet.connect(provider);
        document.getElementById("walletAddress").textContent = userWallet.address;
        fetchAllBalances();
      } catch (err) {
        alert("Failed to decrypt wallet.");
      }
    }

    async function fetchAllBalances() {
      try {
        const [bnbBal, drfBal, usdcBal, usdtBal] = await Promise.all([
          provider.getBalance(userWallet.address),
          new ethers.Contract(DRF_ADDRESS, ["function balanceOf(address) view returns (uint256)"], provider).balanceOf(userWallet.address),
          new ethers.Contract(USDC_ADDRESS, ["function balanceOf(address) view returns (uint256)"], provider).balanceOf(userWallet.address),
          new ethers.Contract(USDT_ADDRESS, ["function balanceOf(address) view returns (uint256)"], provider).balanceOf(userWallet.address),
        ]);

        const bnb = parseFloat(ethers.utils.formatEther(bnbBal));
        const drf = parseFloat(ethers.utils.formatUnits(drfBal, 18));
        const usdc = parseFloat(ethers.utils.formatUnits(usdcBal, 18));
        const usdt = parseFloat(ethers.utils.formatUnits(usdtBal, 18));

        document.getElementById("bnbBalance").textContent = bnb;
        document.getElementById("drfBalance").textContent = drf;
        document.getElementById("usdcBalance").textContent = usdc;
        document.getElementById("usdtBalance").textContent = usdt;

        fetchTokenPrices(bnb, drf, usdc, usdt);
      } catch (err) {
        console.error("Balance fetch failed:", err);
      }
    }

    async function fetchTokenPrices(bnb, drf, usdc, usdt) {
      try {
        const res = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=binancecoin,tether,usd-coin&vs_currencies=usd");
        const prices = await res.json();

        const bnbPrice = prices.binancecoin.usd || 0;
        const usdcPrice = prices["usd-coin"].usd || 0;
        const usdtPrice = prices.tether.usd || 0;

        document.getElementById("bnbPrice").textContent = `$${bnbPrice}`;
        document.getElementById("usdcPrice").textContent = `$${usdcPrice}`;
        document.getElementById("usdtPrice").textContent = `$${usdtPrice}`;

        const totalValue = (bnb * bnbPrice) + (usdc * usdcPrice) + (usdt * usdtPrice);
        document.getElementById("totalValue").textContent = totalValue.toFixed(2);
      } catch (err) {
        console.warn("Token price fetch failed.", err);
      }
    }

    async function checkNetwork() {
      const network = await provider.getNetwork();
      if (network.chainId === 56) {
        document.getElementById("networkStatus").textContent = "Connected to Binance Smart Chain";
      } else {
        document.getElementById("networkStatus").textContent = `Connected to wrong network (Chain ID: ${network.chainId})`;
        document.getElementById("networkStatus").style.color = "red";
      }
    }

    window.onload = () => {
      checkNetwork();
      initializeWallet();
    };
  </script>
</body>
</html>
