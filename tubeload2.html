<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DRFTube Upload</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .drop-zone {
      border: 2px dashed #3b82f6;
      border-radius: 1rem;
      padding: 2rem;
      text-align: center;
      color: #888;
      transition: background 0.2s;
    }
    .drop-zone.dragover {
      background-color: #1e3a8a22;
      border-color: #2563eb;
    }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">
  <header class="p-4 bg-gray-800 shadow-md">
    <h1 class="text-2xl font-bold text-center text-blue-400">DRFTube</h1>
  </header>

  <div class="flex justify-between px-4 pt-4">
    <span id="userEmail"></span>
    <div>
      <button id="loginBtn" class="bg-blue-600 px-4 py-1 rounded hover:bg-blue-700">Login</button>
      <button id="logoutBtn" class="bg-red-500 px-4 py-1 rounded hover:bg-red-600 hidden">Logout</button>
    </div>
  </div>

  <main class="flex-1 px-4 py-6">
    <div class="mb-6 flex space-x-2">
      <button class="tab-btn bg-blue-600 text-white px-4 py-2 rounded" data-tab="upload">Upload</button>
      <button class="tab-btn bg-gray-700 text-white px-4 py-2 rounded" data-tab="videos">My Uploads</button>
    </div>

    <div id="upload" class="tab-content">
      <form id="uploadForm" class="space-y-4">
        <input type="text" id="title" required placeholder="Video Title*" class="w-full p-2 rounded bg-gray-800" />
        <input type="text" id="category" placeholder="Category (Reminder, Quran...)" class="w-full p-2 rounded bg-gray-800" />
        <textarea id="description" placeholder="Description (optional)" class="w-full p-2 rounded bg-gray-800"></textarea>

        <div class="drop-zone" id="dropZone">
          Drag & drop video or click to select
          <input id="file" type="file" accept="video/*" class="hidden" required />
        </div>

        <progress id="progress" value="0" max="100" class="w-full h-2"></progress>
        <button class="bg-blue-500 w-full py-2 rounded hover:bg-blue-600">Upload</button>
        <p id="status" class="text-sm"></p>
      </form>
    </div>

    <div id="videos" class="tab-content hidden">
      <div id="videoList" class="space-y-4">Loading...</div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCdFX1PbNEgubM4Zib7U-hgtJbSOONPk6U",
      authDomain: "drftube-634c6.firebaseapp.com",
      projectId: "drftube-634c6",
      storageBucket: "drftube-634c6.appspot.com",
      messagingSenderId: "819828633864",
      appId: "1:819828633864:web:513002b461259b000cbcbd",
    };

    const PINATA_JWT = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI2YjI3MmJhYy00ZTg5LTQxMzUtOWRlMS1iYzk3OTkzMjBkY2YiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWFjb2luQGdtYWlsLmNvbSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJwaW5fcG9saWN5Ijp7InJlZ2lvbnMiOlt7ImRlc2lyZWRSZXBsaWNhdGlvbkNvdW50IjoxLCJpZCI6IkZSQTEifSx7ImRlc2lyZWRSZXBsaWNhdGlvbkNvdW50IjoxLCJpZCI6Ik5ZQzEifV0sInZlcnNpb24iOjF9LCJtZmFfZW5hYmxlZCI6ZmFsc2UsInN0YXR1cyI6IkFDVElWRSJ9LCJhdXRoZW50aWNhdGlvblR5cGUiOiJzY29wZWRLZXkiLCJzY29wZWRLZXlLZXkiOiJjNmZlNzk2ZjY0YjhlNWI3ZDI1NiIsInNjb3BlZEtleVNlY3JldCI6ImNhNmVkZmIyYzJhNjkzNzYwZGY1NWRhNTJlOTkwMWY1Yjk0Y2EzZjE0ZTI0NmQ0ZWJkMjQxNWE3ZjM3YjhkMWUiLCJleHAiOjE3ODE0MjAyNDF9.jTvLgxmAWy9AYsxFHVVaX4e1086fiQ09txSJo_-TyU4";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const userEmail = document.getElementById("userEmail");

    onAuthStateChanged(auth, user => {
      if (user) {
        document.getElementById("uploadForm").style.display = "block";
        loginBtn.classList.add("hidden");
        logoutBtn.classList.remove("hidden");
        userEmail.textContent = user.email;
      } else {
        document.getElementById("uploadForm").style.display = "none";
        loginBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
        userEmail.textContent = "";
      }
    });

    loginBtn.onclick = () => signInWithPopup(auth, provider).catch(console.error);
    logoutBtn.onclick = () => signOut(auth).catch(console.error);

    const form = document.getElementById("uploadForm");
    const fileInput = document.getElementById("file");
    const dropZone = document.getElementById("dropZone");
    const status = document.getElementById("status");
    const progress = document.getElementById("progress");

    dropZone.addEventListener("click", () => fileInput.click());
    dropZone.addEventListener("dragover", e => {
      e.preventDefault();
      dropZone.classList.add("dragover");
    });
    dropZone.addEventListener("dragleave", () => dropZone.classList.remove("dragover"));
    dropZone.addEventListener("drop", e => {
      e.preventDefault();
      fileInput.files = e.dataTransfer.files;
      dropZone.classList.remove("dragover");
    });

    async function uploadToPinata(file) {
      const data = new FormData();
      data.append("file", file);

      const res = await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS", {
        method: "POST",
        headers: { Authorization: `Bearer ${PINATA_JWT}` },
        body: data,
      });

      if (!res.ok) throw new Error("Upload failed");
      return (await res.json()).IpfsHash;
    }

    async function saveMetadataToFirestore(title, description, category, ipfsHash) {
      await addDoc(collection(db, "videos"), {
        title,
        description,
        category,
        ipfsHash,
        uploadedAt: new Date().toISOString()
      });
    }

    form.addEventListener("submit", async e => {
      e.preventDefault();
      const file = fileInput.files[0];
      const title = form.title.value;
      const description = form.description.value;
      const category = form.category.value;

      if (!file || !title) return status.textContent = "Required fields missing.";

      try {
        status.textContent = "Uploading to IPFS...";
        progress.value = 20;
        const ipfsHash = await uploadToPinata(file);
        progress.value = 60;
        await saveMetadataToFirestore(title, description, category, ipfsHash);
        progress.value = 100;
        status.textContent = "Upload complete âœ…";
        loadVideos();
        form.reset();
      } catch (err) {
        status.textContent = "Upload error: " + err.message;
        console.error(err);
      }
    });

    async function loadVideos() {
      const videoList = document.getElementById("videoList");
      videoList.innerHTML = "Loading...";
      try {
        const q = query(collection(db, "videos"), orderBy("uploadedAt", "desc"));
        const snapshot = await getDocs(q);
        if (snapshot.empty) return videoList.innerHTML = "No videos yet.";

        videoList.innerHTML = "";
        snapshot.forEach(doc => {
          const v = doc.data();
          videoList.innerHTML += `
            <div class="bg-gray-800 p-4 rounded">
              <h3 class="text-lg font-semibold text-blue-400">${v.title}</h3>
              <video class="w-full mt-2" controls>
                <source src="https://gateway.pinata.cloud/ipfs/${v.ipfsHash}" />
              </video>
              <p class="text-sm mt-2">${v.description || "No description"}</p>
              <p class="text-xs text-gray-400">${v.category || "Uncategorized"}</p>
            </div>
          `;
        });
      } catch (e) {
        videoList.innerHTML = "Failed to load videos.";
      }
    }

    loadVideos();

    // Tab handling
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("bg-blue-600"));
        btn.classList.add("bg-blue-600");
        document.querySelectorAll(".tab-content").forEach(t => t.classList.add("hidden"));
        document.getElementById(btn.dataset.tab).classList.remove("hidden");
      });
    });
  </script>
</body>
</html>
