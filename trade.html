<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Buy DrF Tokens</title>
  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <!-- Bootstrap Icons -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    rel="stylesheet"
  />
</head>
<body class="p-4">

  <section id="buy-section" class="container">
    <!-- Buy Form -->
    <form
      id="buy"
      class="col-lg-5 mx-auto"
      aria-labelledby="buyform-label"
      novalidate
    >
      <h3 id="buyform-label" class="fw-bold mb-3 text-center">Buy DrF Tokens</h3>

      <div class="mb-3">
        <label for="walletAddress" class="form-label"
          >Connected Wallet Address</label
        >
        <input
          type="text"
          id="walletAddress"
          class="form-control"
          placeholder="Connect wallet to see address"
          readonly
          aria-readonly="true"
        />
      </div>

      <div class="mb-3">
        <label for="amountBNB" class="form-label">Amount to Invest (BNB)</label>
        <input
          type="number"
          id="amountBNB"
          class="form-control"
          placeholder="Enter BNB amount"
          min="0.001"
          step="0.001"
          aria-describedby="bnbHelp"
          required
          disabled
        />
        <div id="bnbHelp" class="form-text">
          Minimum investment: 0.001 BNB
        </div>
        <div class="invalid-feedback">
          Please enter a valid BNB amount greater than 0.
        </div>
      </div>

      <div class="mb-3">
        <label for="tokenAmount" class="form-label">Estimated DrF Tokens</label>
        <input
          type="text"
          id="tokenAmount"
          class="form-control"
          placeholder="Estimated tokens you will receive"
          readonly
          aria-readonly="true"
        />
      </div>

      <button
        type="submit"
        id="buybtn"
        class="btn btn-primary w-100"
        disabled
        aria-disabled="true"
      >
        Connect Wallet to Buy
      </button>
    </form>
  </section>

  <!-- Referral Info -->
  <section id="referral" class="container mt-5 col-lg-5 mx-auto">
    <h2 class="fw-bold mb-3 text-center">Referral Program</h2>
    <p class="text-center">
      Share your referral link and earn a commission when others buy DrF tokens!
    </p>
    <div class="input-group mb-3">
      <input
        type="text"
        id="referralLink"
        class="form-control"
        readonly
        aria-label="Referral link"
        aria-readonly="true"
      />
      <button
        id="copyReferral"
        class="btn btn-outline-secondary"
        aria-label="Copy referral link"
        title="Copy referral link"
      >
        <i class="bi bi-clipboard"></i>
      </button>
    </div>
    <p class="text-muted text-center">
      Referral commissions are credited instantly on each successful purchase.
    </p>
  </section>

  <!-- Ethers.js & Web3Modal -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.0/dist/ethers.min.js" type="module"></script>
  <script src="https://unpkg.com/@web3modal/html@2.5.5/dist/index.js"></script>

  <script type="module">
    import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.6.0/dist/ethers.esm.min.js";
    import { Web3Modal } from "https://unpkg.com/@web3modal/html@2.5.5/dist/index.js";

    const buyForm = document.getElementById("buy");
    const walletAddressInput = document.getElementById("walletAddress");
    const amountBNBInput = document.getElementById("amountBNB");
    const tokenAmountInput = document.getElementById("tokenAmount");
    const buyBtn = document.getElementById("buybtn");
    const referralLinkInput = document.getElementById("referralLink");
    const copyReferralBtn = document.getElementById("copyReferral");

    // Replace with your actual DrF token contract address and ABI if needed for more precise estimation or contract interaction
    // For demo, we assume 1 BNB = 1000 DrF tokens fixed rate (adjust as needed)
    const TOKEN_RATE = 1000; // tokens per 1 BNB

    // Your dApp URL base - used for referral link
    const dappBaseURL = window.location.origin + window.location.pathname;

    // Web3Modal initialization
    const web3Modal = new Web3Modal({
      projectId: "YOUR_PROJECT_ID", // replace with your WalletConnect Project ID for best support or leave blank for default
      walletConnectVersion: 2,
      themeMode: "light",
      ethereum: {
        appName: "DrF Token Sale",
        chains: [56], // Binance Smart Chain mainnet chain id
      },
    });

    let provider;
    let signer;
    let userAddress = null;

    async function connectWallet() {
      try {
        const instance = await web3Modal.connect();
        provider = new ethers.BrowserProvider(instance);
        signer = await provider.getSigner();
        userAddress = await signer.getAddress();

        // Show connected wallet address
        walletAddressInput.value = userAddress;

        // Enable input and button
        amountBNBInput.disabled = false;
        buyBtn.disabled = false;
        buyBtn.removeAttribute("aria-disabled");
        buyBtn.textContent = "Buy DrF Tokens";

        // Update referral link with wallet address as ref parameter
        referralLinkInput.value = `${dappBaseURL}?ref=${userAddress}`;

        // Listen for amountBNB input change to calculate token amount
        amountBNBInput.addEventListener("input", updateEstimatedTokens);

        // Optional: listen for wallet disconnect
        instance.on("disconnect", resetForm);

      } catch (err) {
        console.error("Wallet connection failed:", err);
      }
    }

    function updateEstimatedTokens() {
      const bnbAmount = parseFloat(amountBNBInput.value);
      if (isNaN(bnbAmount) || bnbAmount < 0.001) {
        tokenAmountInput.value = "";
        buyBtn.disabled = true;
        buyBtn.setAttribute("aria-disabled", "true");
        return;
      }
      const tokens = bnbAmount * TOKEN_RATE;
      tokenAmountInput.value = tokens.toLocaleString(undefined, { maximumFractionDigits: 2 });
      buyBtn.disabled = false;
      buyBtn.removeAttribute("aria-disabled");
    }

    function resetForm() {
      walletAddressInput.value = "";
      amountBNBInput.value = "";
      amountBNBInput.disabled = true;
      tokenAmountInput.value = "";
      buyBtn.disabled = true;
      buyBtn.setAttribute("aria-disabled", "true");
      referralLinkInput.value = "";
      userAddress = null;
    }

    // Handle buy form submit
    buyForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!userAddress) {
        alert("Please connect your wallet first.");
        return;
      }

      const bnbAmount = parseFloat(amountBNBInput.value);
      if (isNaN(bnbAmount) || bnbAmount < 0.001) {
        alert("Please enter a valid BNB amount greater than or equal to 0.001.");
        return;
      }

      try {
        buyBtn.disabled = true;
        buyBtn.textContent = "Processing...";

        // Sending BNB purchase transaction logic here
        // For demo, we'll just simulate with a delay
        // Replace this with your contract interaction code or payment method

        await new Promise((res) => setTimeout(res, 3000));

        alert(`Success! You bought approx ${bnbAmount * TOKEN_RATE} DrF tokens.`);

        // Reset input fields after successful purchase
        amountBNBInput.value = "";
        tokenAmountInput.value = "";
        buyBtn.textContent = "Buy DrF Tokens";
        buyBtn.disabled = false;

      } catch (err) {
        console.error(err);
        alert("Transaction failed or rejected.");
        buyBtn.textContent = "Buy DrF Tokens";
        buyBtn.disabled = false;
      }
    });

    // Copy referral link button
    copyReferralBtn.addEventListener("click", () => {
      if (!referralLinkInput.value) return;
      referralLinkInput.select();
      referralLinkInput.setSelectionRange(0, 99999); // for mobile
      navigator.clipboard.writeText(referralLinkInput.value).then(() => {
        copyReferralBtn.innerHTML = `<i class="bi bi-clipboard-check"></i>`;
        setTimeout(() => {
          copyReferralBtn.innerHTML = `<i class="bi bi-clipboard"></i>`;
        }, 1500);
      });
    });

    // On page load: connect wallet button (disabled), enable on user action
    walletAddressInput.addEventListener("click", () => {
      if (!userAddress) {
        connectWallet();
      }
    });

    // You can also add a separate Connect Wallet button if you want:
    // For simplicity, here wallet connects when user clicks the walletAddressInput

  </script>

  <!-- Bootstrap JS Bundle -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
    crossorigin="anonymous"
  ></script>
</body>
</html>
