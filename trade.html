<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Buy DrF Token - Digital Rufiya Sale</title>
  <meta name="description" content="Buy DRF token securely with USDC. Join Digital Rufiya's token sale.">
  <link rel="icon" href="/logo.png" type="image/png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
  <script type="module" src="https://cdn.jsdelivr.net/gh/dappbuilder/tokensale/tokensaleuiv1.js"></script>
</head>
<body class="bg-light">

  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand fw-bold" href="#">Digital Rufiya</a>
      <div class="ms-auto">
        <w3m-button></w3m-button>
      </div>
    </div>
  </nav>

  <header class="py-5 text-center bg-white shadow-sm">
    <div class="container">
      <img src="/logo.png" alt="DrF Logo" width="80" class="mb-3">
      <h1 class="display-5 fw-bold">Buy DrF Token</h1>
      <p class="lead">Join the Digital Rufiya revolution. Buy tokens using USDC on Binance Smart Chain.</p>
      <button class="btn btn-outline-primary mt-2" id="switch">Switch to BSC</button>
    </div>
  </header>

  <section class="py-4 text-center bg-white border-bottom">
    <div class="container">
      <div class="row gy-3 justify-content-center">
        <div class="col-md-4">
          <div class="card p-3">
            <h5>Token Name</h5>
            <p class="text-muted">Digital Rufiya</p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card p-3">
            <h5>Token Symbol</h5>
            <p class="text-muted">DrF</p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card p-3">
            <h5>Token Address</h5>
            <p class="text-break text-muted">
              <a href="https://bscscan.com/token/0x82dAa32579728EDAd1b940Ad26f9336845C8A3c7" target="_blank">
                0x82dAa3...8A3c7 <i class="bi bi-box-arrow-up-right"></i>
              </a>
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section id="buy" class="py-5 text-center">
    <div class="container">
      <h2 class="mb-4">Buy DrF with USDC</h2>
      <input type="number" id="buyAmount" class="form-control mb-3 w-50 mx-auto" placeholder="Enter amount of DrF tokens" min="1" step="any" />
      <button id="buyBtn" class="btn btn-primary">Buy DrF</button>
      <p id="buyStatus" class="mt-3 text-muted"></p>
    </div>
  </section>

  <section id="referral" class="py-5 bg-light text-center">
    <div class="container">
      <h2 class="mb-3">Referral Program</h2>
      <p>Share your referral link and earn extra DrF tokens when others buy using your link.</p>
      <input type="text" id="refLink" class="form-control w-50 mx-auto mb-3" readonly value="https://yourdomain.com/buy.html?ref=0xYourAddress" />
      <button class="btn btn-outline-secondary" onclick="copyReferral()">Copy Referral Link</button>
    </div>
  </section>

  <footer class="py-4 bg-dark text-white text-center">
    <div class="container">
      <p class="mb-0">&copy; 2025 Digital Rufiya. All rights reserved.</p>
    </div>
  </footer>

  <script>
    const contractAddress = '0x82dAa32579728EDAd1b940Ad26f9336845C8A3c7';
    const tokenSymbol = 'DrF';
    const tokenName = 'Digital Rufiya';

    // Your sale wallet address here (receives USDC)
    const saleRecipient = '0xYourSaleWalletAddressHere';

    // Price rate: 15.42 DrF per 1 USDC
    const drfPerUSDC = 15.42;

    // USDC contract on BSC Mainnet (18 decimals)
    const USDCContractAddress = '0x8ac76a51cc950d9822d68b83fe1ad97b32cd580d';

    const USDC_ABI = [
      {
        "constant": false,
        "inputs": [
          { "name": "_to", "type": "address" },
          { "name": "_value", "type": "uint256" }
        ],
        "name": "transfer",
        "outputs": [ { "name": "", "type": "bool" } ],
        "type": "function"
      },
      {
        "constant": true,
        "inputs": [ { "name": "_owner", "type": "address" } ],
        "name": "balanceOf",
        "outputs": [ { "name": "balance", "type": "uint256" } ],
        "type": "function"
      }
    ];

    document.getElementById("switch").addEventListener("click", async () => {
      if (typeof window.ethereum !== 'undefined') {
        try {
          await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: '0x38' }] // BSC Mainnet
          });
        } catch (e) {
          alert('Switch failed. Please open MetaMask and manually switch to Binance Smart Chain.');
        }
      } else {
        alert('No wallet detected');
      }
    });

    function copyReferral() {
      const ref = document.getElementById("refLink");
      ref.select();
      ref.setSelectionRange(0, 99999);
      document.execCommand("copy");
      alert("Referral link copied!");
    }

    document.getElementById('buyBtn').addEventListener('click', async () => {
      const amountDrf = Number(document.getElementById('buyAmount').value);
      if (!amountDrf || amountDrf <= 0) {
        alert('Please enter a valid DrF token amount.');
        return;
      }

      if (typeof window.ethereum === 'undefined') {
        alert('No Ethereum wallet detected. Please install MetaMask or another wallet.');
        return;
      }

      try {
        const web3 = new Web3(window.ethereum);
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        const accounts = await web3.eth.getAccounts();
        const from = accounts[0];

        // Calculate USDC needed (18 decimals)
        const usdcAmount = amountDrf / drfPerUSDC;
        const usdcAmountWei = web3.utils.toWei(usdcAmount.toString(), 'ether');

        // Instantiate USDC contract
        const usdcContract = new web3.eth.Contract(USDC_ABI, USDCContractAddress);

        // Check user balance
        const balance = await usdcContract.methods.balanceOf(from).call();
        if (BigInt(balance) < BigInt(usdcAmountWei)) {
          alert('Insufficient USDC balance.');
          return;
        }

        // Send USDC to sale wallet
        document.getElementById('buyStatus').innerText = 'Sending USDC... Please confirm in your wallet.';

        const tx = await usdcContract.methods.transfer(saleRecipient, usdcAmountWei).send({ from });

        document.getElementById('buyStatus').innerText = `Success! You bought ${amountDrf} DrF tokens. TX Hash: ${tx.transactionHash}`;
        document.getElementById('buyAmount').value = '';

      } catch (error) {
        console.error(error);
        alert('Transaction failed or rejected.');
        document.getElementById('buyStatus').innerText = 'Transaction failed or rejected.';
      }
    });
  </script>

</body>
</html>
