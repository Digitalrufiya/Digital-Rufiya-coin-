<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Upload to Pinata + Save URL in Firestore</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  #status { margin-top: 10px; color: green; }
  #error { margin-top: 10px; color: red; }
</style>
</head>
<body>

<h2>Upload Profile Photo</h2>
<input type="file" id="fileInput" accept="image/*" />
<button id="uploadBtn" disabled>Upload & Save</button>

<div id="status"></div>
<div id="error"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
    authDomain: "drfsocial-23a06.firebaseapp.com",
    databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
    projectId: "drfsocial-23a06",
    storageBucket: "drfsocial-23a06.firebasestorage.app",
    messagingSenderId: "608135115201",
    appId: "1:608135115201:web:dc999df2c0f37241ff3f40",
    measurementId: "G-W6VHMP77YR"
  };

  const PINATA_JWT = "YOUR_FULL_PINATA_JWT_HERE";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const fileInput = document.getElementById('fileInput');
  const uploadBtn = document.getElementById('uploadBtn');
  const statusDiv = document.getElementById('status');
  const errorDiv = document.getElementById('error');

  fileInput.addEventListener('change', () => {
    uploadBtn.disabled = !fileInput.files.length;
    statusDiv.textContent = '';
    errorDiv.textContent = '';
  });

  uploadBtn.addEventListener('click', async () => {
    errorDiv.textContent = '';
    statusDiv.textContent = 'Uploading image to Pinata...';
    uploadBtn.disabled = true;

    const file = fileInput.files[0];
    if (!file) {
      errorDiv.textContent = 'Please select a file first.';
      uploadBtn.disabled = false;
      return;
    }

    try {
      const ipfsURL = await uploadFileToPinata(file);
      statusDiv.textContent = `Upload successful! IPFS URL: ${ipfsURL}`;

      const user = await waitForUser();
      if (!user) {
        errorDiv.textContent = 'You must be signed in to save the URL.';
        uploadBtn.disabled = false;
        return;
      }

      // Save the IPFS URL under the user's document in Firestore
      await setDoc(doc(db, "users", user.uid), { profilePhotoURL: ipfsURL }, { merge: true });
      statusDiv.textContent += ' â€” Saved to Firestore!';
    } catch (err) {
      errorDiv.textContent = 'Error: ' + err.message;
    } finally {
      uploadBtn.disabled = false;
    }
  });

  async function uploadFileToPinata(file) {
    const url = 'https://api.pinata.cloud/pinning/pinFileToIPFS';
    const formData = new FormData();
    formData.append('file', file);

    const res = await fetch(url, {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${PINATA_JWT}`
      },
      body: formData
    });

    if (!res.ok) {
      const errorText = await res.text();
      throw new Error('Pinata upload failed: ' + errorText);
    }

    const data = await res.json();
    return `https://gateway.pinata.cloud/ipfs/${data.IpfsHash}`;
  }

  function waitForUser() {
    return new Promise((resolve) => {
      const unsubscribe = onAuthStateChanged(auth, user => {
        unsubscribe();
        resolve(user);
      });
      // Timeout after 10s
      setTimeout(() => {
        unsubscribe();
        resolve(null);
      }, 10000);
    });
  }
</script>

</body>
</html>
