<!DOCTYPE html>
<html>
<head>
  <title>Public Profile Uploader</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 500px;
      margin: auto;
      background: #f8f8f8;
    }
    h2 {
      text-align: center;
    }
    input, select, button {
      display: block;
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    img {
      margin-top: 10px;
      max-width: 100%;
      height: auto;
      border-radius: 10px;
    }
    .profile {
      background: white;
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h2>Public Profile</h2>

  <input type="text" id="name" placeholder="Full Name" required />
  <input type="text" id="wallet" placeholder="Wallet Address (0x...)" required />
  <select id="gender">
    <option value="male">Male</option>
    <option value="female">Female</option>
  </select>
  <input type="file" id="photo" accept="image/*" required />

  <button onclick="uploadProfile()">Submit Profile</button>

  <div id="message"></div>
  <hr>
  <h3>Public Profiles</h3>
  <div id="profiles"></div>

  <script>
    const pinataApiKey = "3d87f9ed904df892654c";
    const pinataSecretApiKey = "a279e8854d44af6cb17047da98aa772a19022aaa20949b137f9fb1027c03bf9f";
    const firebaseUrl = "https://drfsocial-23a06-default-rtdb.firebaseio.com/profiles.json";

    async function uploadProfile() {
      const name = document.getElementById("name").value;
      const wallet = document.getElementById("wallet").value;
      const gender = document.getElementById("gender").value;
      const photoFile = document.getElementById("photo").files[0];

      if (!name || !wallet || !photoFile) {
        alert("Please fill in all fields and select a photo.");
        return;
      }

      document.getElementById("message").innerText = "Uploading photo to IPFS...";

      const formData = new FormData();
      formData.append("file", photoFile);

      const res = await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS", {
        method: "POST",
        headers: {
          pinata_api_key: pinataApiKey,
          pinata_secret_api_key: pinataSecretApiKey,
        },
        body: formData,
      });

      const data = await res.json();

      if (data.IpfsHash) {
        const imageUrl = `https://gateway.pinata.cloud/ipfs/${data.IpfsHash}`;

        const profileData = {
          name,
          wallet,
          gender,
          image: imageUrl,
          timestamp: Date.now()
        };

        await fetch(firebaseUrl, {
          method: "POST",
          body: JSON.stringify(profileData),
          headers: { "Content-Type": "application/json" }
        });

        document.getElementById("message").innerText = "✅ Profile saved!";
        loadProfiles();
      } else {
        document.getElementById("message").innerText = "❌ Upload failed!";
      }
    }

    async function loadProfiles() {
      const res = await fetch(firebaseUrl);
      const data = await res.json();
      const output = document.getElementById("profiles");
      output.innerHTML = "";

      if (data) {
        Object.values(data)
          .sort((a, b) => b.timestamp - a.timestamp)
          .forEach(profile => {
            const div = document.createElement("div");
            div.className = "profile";
            div.innerHTML = `
              <img src="${profile.image}" alt="Profile Photo" />
              <strong>Name:</strong> ${profile.name}<br>
              <strong>Wallet:</strong> ${profile.wallet}<br>
              <strong>Gender:</strong> ${profile.gender}
            `;
            output.appendChild(div);
          });
      }
    }

    loadProfiles();
  </script>
</body>
</html>
