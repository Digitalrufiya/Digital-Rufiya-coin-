<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Upload Image to Pinata + Save URL to Firebase</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  #status { margin-top: 10px; color: green; }
  #error { margin-top: 10px; color: red; }
</style>
</head>
<body>

<h2>Upload Profile Photo</h2>
<input type="file" id="fileInput" accept="image/*" />
<button id="uploadBtn" disabled>Upload to Pinata & Save</button>

<div id="status"></div>
<div id="error"></div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<script>
  // TODO: Replace this config with your Firebase project config
  const firebaseConfig = {
    apiKey: "YOUR_FIREBASE_API_KEY",
    authDomain: "YOUR_FIREBASE_AUTH_DOMAIN",
    projectId: "YOUR_FIREBASE_PROJECT_ID",
    storageBucket: "YOUR_FIREBASE_STORAGE_BUCKET",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Pinata JWT (replace with your JWT token)
  const PINATA_JWT = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // truncated for safety, paste your full token here

  const fileInput = document.getElementById('fileInput');
  const uploadBtn = document.getElementById('uploadBtn');
  const statusDiv = document.getElementById('status');
  const errorDiv = document.getElementById('error');

  // Enable upload button only when file is selected
  fileInput.addEventListener('change', () => {
    uploadBtn.disabled = !fileInput.files.length;
    statusDiv.textContent = '';
    errorDiv.textContent = '';
  });

  uploadBtn.addEventListener('click', async () => {
    errorDiv.textContent = '';
    statusDiv.textContent = 'Uploading image to Pinata...';
    uploadBtn.disabled = true;

    const file = fileInput.files[0];
    if (!file) {
      errorDiv.textContent = 'Please select an image file first.';
      uploadBtn.disabled = false;
      return;
    }

    try {
      const ipfsURL = await uploadFileToPinata(file);
      statusDiv.textContent = `Upload successful! IPFS URL: ${ipfsURL}`;

      // Wait for user auth state
      const user = await waitForUser();
      if (!user) {
        errorDiv.textContent = 'User not signed in. Cannot save to Firestore.';
        uploadBtn.disabled = false;
        return;
      }

      // Save URL to Firestore under user's document
      await db.collection('users').doc(user.uid).set(
        { profilePhotoURL: ipfsURL },
        { merge: true }
      );

      statusDiv.textContent += ' â€” Saved to Firestore!';
    } catch (err) {
      errorDiv.textContent = 'Error: ' + err.message;
    } finally {
      uploadBtn.disabled = false;
    }
  });

  // Upload file to Pinata and return IPFS URL
  async function uploadFileToPinata(file) {
    const url = 'https://api.pinata.cloud/pinning/pinFileToIPFS';
    const formData = new FormData();
    formData.append('file', file);

    const res = await fetch(url, {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${PINATA_JWT}`
      },
      body: formData
    });

    if (!res.ok) {
      const errorText = await res.text();
      throw new Error('Pinata upload failed: ' + errorText);
    }

    const data = await res.json();
    return `https://gateway.pinata.cloud/ipfs/${data.IpfsHash}`;
  }

  // Wait for Firebase user auth state, or timeout after 10 seconds
  function waitForUser() {
    return new Promise((resolve) => {
      const timeout = setTimeout(() => resolve(null), 10000);
      const unsubscribe = auth.onAuthStateChanged(user => {
        clearTimeout(timeout);
        unsubscribe();
        resolve(user);
      });
    });
  }
</script>

</body>
</html>
