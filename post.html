<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mini Facebook - DRF Wallet</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .post {
      background:#fff; padding:10px; margin:10px 0; border-radius:10px;
    }
    .avatar {
      width:30px; height:30px; border-radius:50%; vertical-align:middle;
    }
    .media {
      max-width: 100%; margin-top: 10px; border-radius: 10px;
    }
    .like-btn, .comment-btn {
      cursor: pointer; color: #0baf9a; margin-right: 15px; user-select:none;
    }
    .comments-section {
      margin-top: 10px; padding-left: 40px; font-size: 14px;
    }
    .comment {
      margin-bottom: 5px;
      border-bottom: 1px solid #eee;
      padding-bottom: 3px;
    }
    .comment strong {
      color: #0baf9a;
    }
  </style>
</head>
<body style="font-family:sans-serif;background:#e8f7f4;">
  <div style="max-width:600px;margin:auto;padding:20px;">
    <h2>DRF Wallet Mini Facebook</h2>
    <div id="profileInfo" style="margin-bottom:20px;text-align:center;"></div>

    <textarea id="postContent" placeholder="What's on your mind?" style="width:100%;padding:10px;"></textarea><br/>
    <input type="file" id="mediaInput" accept="image/*,video/*" />
    <small>Upload photo or video (max 3 minutes)</small><br/>
    <button onclick="submitPost()" style="margin-top:10px;padding:10px 20px;background:#0baf9a;color:#fff;border:none;border-radius:5px;">Post</button>

    <h3 style="margin-top:30px;">Community Posts</h3>
    <div id="postFeed"></div>
  </div>

  <script>
    const profile = JSON.parse(localStorage.getItem("drf_profile"));
    if (!profile) window.location.href = "profile.html";

    const profileInfo = document.getElementById("profileInfo");
    profileInfo.innerHTML = `<img src="${profile.avatar}" style="width:50px;height:50px;border-radius:50%;" /><br><strong>${profile.name}</strong>`;

    function submitPost() {
      const content = document.getElementById("postContent").value.trim();
      const mediaInput = document.getElementById("mediaInput");

      if (!content && mediaInput.files.length === 0) {
        return alert("Please write something or upload a photo/video.");
      }

      if (mediaInput.files.length > 0) {
        const file = mediaInput.files[0];
        if (file.type.startsWith("video/")) {
          // Check video duration (max 3 minutes)
          const url = URL.createObjectURL(file);
          const video = document.createElement("video");
          video.preload = "metadata";
          video.src = url;
          video.onloadedmetadata = () => {
            URL.revokeObjectURL(url);
            if (video.duration > 180) { // 180 seconds = 3 minutes
              alert("Video duration exceeds 3 minutes limit.");
              return;
            } else {
              readFileAndSavePost(file, content);
            }
          };
        } else {
          // Image or other media, no duration check needed
          readFileAndSavePost(file, content);
        }
      } else {
        // Text only post
        savePost(null, content);
      }
    }

    function readFileAndSavePost(file, content) {
      const reader = new FileReader();
      reader.onload = function () {
        savePost(reader.result, content, file.type);
      };
      reader.readAsDataURL(file);
    }

    function savePost(mediaData, content, mediaType) {
      const posts = JSON.parse(localStorage.getItem("drf_posts")) || [];

      const newPost = {
        id: Date.now(),
        author: profile.name,
        avatar: profile.avatar,
        content,
        mediaData: mediaData || null,
        mediaType: mediaType || null,
        timestamp: new Date().toLocaleString(),
        likes: 0,
        comments: []
      };

      posts.unshift(newPost);
      localStorage.setItem("drf_posts", JSON.stringify(posts));

      document.getElementById("postContent").value = "";
      document.getElementById("mediaInput").value = "";
      renderPosts();
    }

    function renderPosts() {
      const postFeed = document.getElementById("postFeed");
      const posts = JSON.parse(localStorage.getItem("drf_posts")) || [];

      postFeed.innerHTML = posts.map(p => `
        <div class="post" data-id="${p.id}">
          <img src="${p.avatar}" class="avatar" />
          <strong>${p.author}</strong><br/>
          <p>${escapeHtml(p.content)}</p>
          ${renderMedia(p.mediaData, p.mediaType)}
          <small>${p.timestamp}</small><br/>
          <span class="like-btn" onclick="toggleLike(${p.id})">üëç Like (${p.likes})</span>
          <span class="comment-btn" onclick="toggleComments(${p.id})">üí¨ Comment (${p.comments.length})</span>
          <div class="comments-section" id="comments-${p.id}" style="display:none;">
            ${renderComments(p.comments, p.id)}
            <input type="text" id="comment-input-${p.id}" placeholder="Write a comment..." style="width:80%;padding:5px;margin-top:5px;" />
            <button onclick="addComment(${p.id})" style="padding:5px 10px;background:#0baf9a;color:#fff;border:none;border-radius:3px;">Add</button>
          </div>
        </div>
      `).join("");
    }

    function renderMedia(mediaData, mediaType) {
      if (!mediaData) return "";
      if (mediaType.startsWith("image/")) {
        return `<img src="${mediaData}" class="media" alt="Posted image" />`;
      }
      if (mediaType.startsWith("video/")) {
        return `<video controls class="media" src="${mediaData}"></video>`;
      }
      return "";
    }

    function toggleLike(postId) {
      let posts = JSON.parse(localStorage.getItem("drf_posts")) || [];
      const idx = posts.findIndex(p => p.id === postId);
      if (idx !== -1) {
        posts[idx].likes++;
        localStorage.setItem("drf_posts", JSON.stringify(posts));
        renderPosts();
      }
    }

    function toggleComments(postId) {
      const commentsDiv = document.getElementById(`comments-${postId}`);
      if (commentsDiv.style.display === "none") {
        commentsDiv.style.display = "block";
      } else {
        commentsDiv.style.display = "none";
      }
    }

    function addComment(postId) {
      const input = document.getElementById(`comment-input-${postId}`);
      const commentText = input.value.trim();
      if (!commentText) return alert("Please write a comment.");

      let posts = JSON.parse(localStorage.getItem("drf_posts")) || [];
      const idx = posts.findIndex(p => p.id === postId);
      if (idx !== -1) {
        posts[idx].comments.push({
          author: profile.name,
          avatar: profile.avatar,
          text: commentText,
          timestamp: new Date().toLocaleString()
        });
        localStorage.setItem("drf_posts", JSON.stringify(posts));
        input.value = "";
        renderPosts();
        toggleComments(postId); // Keep comments visible after adding
      }
    }

    // Helper function to escape HTML in posts
    function escapeHtml(text) {
      if (!text) return "";
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    renderPosts();
  </script>
</body>
</html>
