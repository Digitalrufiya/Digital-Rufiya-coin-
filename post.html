<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Post - DRF Social</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 2rem auto; }
    input, textarea, button { width: 100%; margin: 0.5rem 0; padding: 0.5rem; }
    video, img { max-width: 100%; margin-top: 1rem; }
  </style>
  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
    import { getDatabase, ref, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js";
    import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-storage.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
      authDomain: "drfsocial-23a06.firebaseapp.com",
      databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
      projectId: "drfsocial-23a06",
      storageBucket: "drfsocial-23a06.firebasestorage.app",
      messagingSenderId: "608135115201",
      appId: "1:608135115201:web:b37dffeb550941ffff3f40",
      measurementId: "G-TPT7QMWDYE"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);
    const auth = getAuth(app);

    let currentUser = null;

    onAuthStateChanged(auth, user => {
      if (user) {
        currentUser = user;
        document.getElementById("userinfo").textContent = `Logged in as: ${user.email}`;
      } else {
        currentUser = null;
        document.getElementById("userinfo").textContent = 'Not logged in. Please login first.';
        document.getElementById("postForm").style.display = 'none';
      }
    });

    // File size & duration limits
    const MAX_PHOTO_SIZE = 100 * 1024 * 1024; // 100MB
    const MAX_VIDEO_DURATION = 2 * 60; // 2 minutes in seconds

    // Video validation helper
    function validateVideoDuration(file) {
      return new Promise((resolve, reject) => {
        const url = URL.createObjectURL(file);
        const video = document.createElement('video');
        video.preload = 'metadata';
        video.src = url;
        video.onloadedmetadata = function () {
          URL.revokeObjectURL(url);
          if (video.duration <= MAX_VIDEO_DURATION) {
            resolve(true);
          } else {
            resolve(false);
          }
        };
        video.onerror = () => {
          resolve(false);
        };
      });
    }

    async function handlePost(e) {
      e.preventDefault();
      if (!currentUser) {
        alert("You must be logged in to post.");
        return;
      }

      const caption = document.getElementById("caption").value.trim();
      const fileInput = document.getElementById("mediaFile");
      const file = fileInput.files[0];

      if (!file) {
        alert("Please select a photo or video to upload.");
        return;
      }

      const isVideo = file.type.startsWith("video/");
      const isPhoto = file.type.startsWith("image/");

      if (!isVideo && !isPhoto) {
        alert("Only image and video files are allowed.");
        return;
      }

      // Validate file size
      if (file.size > MAX_PHOTO_SIZE) {
        alert("File too large! Max 100MB allowed.");
        return;
      }

      if (isVideo) {
        const validDuration = await validateVideoDuration(file);
        if (!validDuration) {
          alert("Video too long! Maximum duration is 2 minutes.");
          return;
        }
      }

      // Upload to Firebase Storage
      const timestamp = Date.now();
      const ext = file.name.split('.').pop();
      const storagePath = `posts/${currentUser.uid}/${timestamp}.${ext}`;
      const storageReference = storageRef(storage, storagePath);

      const uploadTask = uploadBytesResumable(storageReference, file);

      uploadTask.on('state_changed', 
        (snapshot) => {
          // Optionally handle progress here
          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          document.getElementById('progress').textContent = `Upload is ${progress.toFixed(2)}% done`;
        }, 
        (error) => {
          alert("Upload failed: " + error.message);
        }, 
        () => {
          getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => {
            // Save post data to database
            const postsRef = ref(db, 'posts');
            push(postsRef, {
              uid: currentUser.uid,
              email: currentUser.email,
              caption: caption,
              mediaUrl: downloadURL,
              mediaType: isVideo ? 'video' : 'photo',
              timestamp: serverTimestamp()
            }).then(() => {
              alert("Post uploaded successfully!");
              document.getElementById("postForm").reset();
              document.getElementById('preview').innerHTML = '';
              document.getElementById('progress').textContent = '';
            }).catch((err) => {
              alert("Failed to save post: " + err.message);
            });
          });
        }
      );
    }

    // Preview media before upload
    function previewFile() {
      const preview = document.getElementById('preview');
      preview.innerHTML = '';
      const fileInput = document.getElementById("mediaFile");
      const file = fileInput.files[0];
      if (!file) return;

      if (file.type.startsWith("image/")) {
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        preview.appendChild(img);
      } else if (file.type.startsWith("video/")) {
        const video = document.createElement('video');
        video.src = URL.createObjectURL(file);
        video.controls = true;
        preview.appendChild(video);
      }
    }
  </script>
</head>
<body>
  <h2>Post to DRF Social</h2>
  <div id="userinfo">Checking login status...</div>

  <form id="postForm" onsubmit="handlePost(event)" enctype="multipart/form-data">
    <textarea id="caption" placeholder="Write something..." maxlength="300"></textarea>
    <input type="file" id="mediaFile" accept="image/*,video/*" onchange="previewFile()" required />
    <div id="preview"></div>
    <div id="progress" style="color: green;"></div>
    <button type="submit">Post</button>
  </form>
</body>
</html>
