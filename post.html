<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DRFBook - Mini Facebook with Media</title>
  <style>
    body { font-family: sans-serif; background: #e8f7f4; max-width: 600px; margin: auto; padding: 20px; }
    #profileInfo img { width: 50px; height: 50px; border-radius: 50%; }
    .post { background: white; padding: 15px; margin: 15px 0; border-radius: 10px; }
    .post-header { display: flex; align-items: center; gap: 10px; }
    .post-content { margin: 10px 0; white-space: pre-wrap; }
    .post-media img, .post-media video { max-width: 100%; border-radius: 8px; margin-top: 10px; }
    button { background: #0baf9a; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .reaction-btn { cursor: pointer; margin-right: 10px; }
    #searchInput { width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ccc; }
    #loadMoreBtn { margin: 10px 0; }
  </style>
</head>
<body>

<h2>DRFBook</h2>

<div id="profileInfo"></div>

<textarea id="postContent" placeholder="What's on your mind?" rows="3" style="width: 100%; padding: 10px; margin-top:10px;"></textarea><br/>
<input type="file" id="media" accept="image/*,video/mp4,video/quicktime" /><br/><br/>
<button id="postBtn" onclick="submitPost()">Post</button>

<input type="text" id="searchInput" placeholder="Search posts..." oninput="renderPosts()" />

<h3>Community Posts</h3>
<div id="postFeed"></div>
<button id="loadMoreBtn" onclick="loadMorePosts()">Load More</button>

<script>
  const scriptURL = 'https://script.google.com/macros/s/AKfycbyuW-IGR9vZcUlhwp1IKgAEsNefIEM4XybxqykGQKvsDZa03Ec1J_mAu4JHbobXB4CjCQ/exec
  const profile = JSON.parse(localStorage.getItem("drf_profile"));
  if (!profile) window.location.href = "profile.html";

  const profileInfo = document.getElementById("profileInfo");
  profileInfo.innerHTML = `<img src="${profile.avatar}" alt="avatar" /><br><strong>${profile.name}</strong>`;

  let allPosts = [];
  let visibleCount = 5;

  async function submitPost() {
    const content = document.getElementById("postContent").value.trim();
    const mediaInput = document.getElementById("media");
    const file = mediaInput.files[0];

    if (!content && !file) {
      alert("Write something or upload media.");
      return;
    }
    
    // Disable post button while uploading
    const postBtn = document.getElementById("postBtn");
    postBtn.disabled = true;

    let mediaBase64 = null;
    let mediaName = null;

    if(file) {
      // Limit video length client-side (optional, only videos max 3 min)
      if(file.type.startsWith('video/')) {
        const maxDurationSec = 180;
        // No direct way to check duration here, skipping for now or can be implemented with video element (advanced)
      }
      
      mediaName = file.name;

      // Convert file to base64
      mediaBase64 = await toBase64(file);
    }

    // Prepare post data as JSON
    const postData = {
      author: profile.name,
      avatar: profile.avatar,
      content: content,
      mediaBase64: mediaBase64,
      mediaName: mediaName,
    };

    try {
      const res = await fetch(scriptURL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(postData)
      });
      const result = await res.json();
      if (result.status === 'success') {
        document.getElementById("postContent").value = "";
        mediaInput.value = "";
        await loadAllPosts();
      } else {
        alert("Failed to post: " + (result.message || "Unknown error"));
      }
    } catch(e) {
      alert("Error posting: " + e.message);
    } finally {
      postBtn.disabled = false;
    }
  }

  function toBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => {
        // Strip "data:*/*;base64," prefix from reader.result
        const base64String = reader.result.split(',')[1];
        resolve(base
