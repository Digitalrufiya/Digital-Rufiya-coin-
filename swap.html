<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Swap Tokens - DRF Wallet</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Swap Tokens</h1>

    <label>From</label>
    <select id="fromToken">
      <option value="DRF">DRF</option>
    </select>

    <label>To</label>
    <select id="toToken">
      <option value="USDC">USDC</option>
      <option value="USDT">USDT</option>
      <option value="BNB">BNB</option>
      <option value="WBNB">WBNB</option>
    </select>

    <input type="number" id="swapAmount" placeholder="Amount to swap" />
    <button onclick="performSwap()">Swap</button>
    <p id="status"></p>
  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <a href="dashboard.html" class="tab-item"><img src="icons/dashboard.svg" alt="Dashboard">Dashboard</a>
    <a href="send.html" class="tab-item"><img src="icons/send.svg" alt="Send">Send</a>
    <a href="swap.html" class="tab-item"><img src="icons/swap.svg" alt="Swap">Swap</a>
    <a href="transactions.html" class="tab-item"><img src="icons/tx.svg" alt="Tx">Transactions</a>
    <a href="tokensale.html" class="tab-item"><img src="icons/token.svg" alt="Token">Token Sale</a>
  </div>

  <script>
    const DRF_CONTRACT = "0x7788a60dbC85AB46767F413EC7d51F149AA1bec6";
    const PANCAKE_ROUTER = "0x10ED43C718714eb63d5aA57B78B54704E256024E"; // BSC Mainnet
    const ADMIN_ADDRESS = "0x88253D87990EdD1E647c3B6eD21F57fb061a3040";
    const ABI = [
      "function approve(address spender, uint value) public returns (bool)",
      "function decimals() view returns (uint8)"
    ];
    const routerABI = [
      "function swapExactTokensForTokensSupportingFeeOnTransferTokens(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline) external",
    ];

    async function performSwap() {
      const from = document.getElementById("fromToken").value;
      const to = document.getElementById("toToken").value;
      const amount = parseFloat(document.getElementById("swapAmount").value);

      if (!window.ethereum || !amount) {
        alert("Please connect MetaMask and enter amount.");
        return;
      }

      const provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      const signer = provider.getSigner();
      const userAddress = await signer.getAddress();

      const fromToken = new ethers.Contract(DRF_CONTRACT, ABI, signer);
      const router = new ethers.Contract(PANCAKE_ROUTER, routerABI, signer);

      const decimals = await fromToken.decimals();
      const fullAmount = ethers.utils.parseUnits(amount.toString(), decimals);
      const feeAmount = fullAmount.mul(5).div(100);
      const netAmount = fullAmount.sub(feeAmount);

      await fromToken.approve(PANCAKE_ROUTER, fullAmount);

      const path = [DRF_CONTRACT, toTokenAddress(to)];
      const deadline = Math.floor(Date.now() / 1000) + 60 * 10;

      try {
        // Send 5% to admin
        await fromToken.transfer(ADMIN_ADDRESS, feeAmount);

        // Swap remaining
        await router.swapExactTokensForTokensSupportingFeeOnTransferTokens(
          netAmount,
          0,
          path,
          userAddress,
          deadline
        );

        document.getElementById("status").innerText = "Swap successful!";
      } catch (err) {
        alert("Swap failed: " + err.message);
      }
    }

    function toTokenAddress(symbol) {
      const map = {
        USDC: "0x8ac76a51cc950d9822d68b83fe1ad97b32cd580d",
        USDT: "0x55d398326f99059ff775485246999027b3197955",
        BNB: "0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee", // pseudo-address for native token
        WBNB: "0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c"
      };
      return map[symbol];
    }
  </script>
</body>
</html>
