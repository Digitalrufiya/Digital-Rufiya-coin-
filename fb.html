<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Social Media MVP</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: 30px auto;
      padding: 0 20px;
    }
    .profile {
      display: flex;
      align-items: center;
      margin-bottom: 30px;
    }
    .avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid #1877f2;
      object-fit: cover;
      margin-right: 20px;
    }
    .fullname {
      font-size: 22px;
      font-weight: bold;
      color: #1877f2;
    }
    #logoutBtn {
      margin-left: auto;
      cursor: pointer;
      background: #1877f2;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
    }
    #postForm {
      margin-bottom: 40px;
    }
    #posts {
      border-top: 1px solid #ddd;
      padding-top: 20px;
    }
    .post {
      border-bottom: 1px solid #eee;
      padding: 15px 0;
    }
    .post img, .post video {
      max-width: 100%;
      max-height: 300px;
      display: block;
      margin-top: 10px;
    }
    .post-text {
      margin-top: 10px;
      font-size: 16px;
    }
    .reaction-btn {
      cursor: pointer;
      margin-right: 10px;
      user-select: none;
    }
  </style>
</head>
<body>

  <div id="authSection">
    <button id="loginBtn">Login with Google</button>
    <button id="resetPasswordBtn" style="display:none;">Reset Password</button>
  </div>

  <div id="userSection" style="display:none;">
    <div class="profile">
      <img id="avatar" class="avatar" src="" alt="Avatar" />
      <div class="fullname" contenteditable="true" title="Click to edit your name" id="fullname"></div>
      <button id="logoutBtn">Logout</button>
    </div>

    <form id="postForm">
      <textarea id="postText" rows="3" placeholder="What's on your mind?" style="width:100%"></textarea><br/>
      <input type="file" id="mediaFile" accept="image/*,video/*" /><br/><br/>
      <button type="submit">Post</button>
    </form>

    <div id="posts"></div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import {
    getAuth,
    GoogleAuthProvider,
    signInWithPopup,
    onAuthStateChanged,
    signOut,
    sendPasswordResetEmail,
    updateProfile,
    reauthenticateWithCredential,
    EmailAuthProvider,
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

  import {
    getDatabase,
    ref,
    set,
    get,
    onValue,
    push,
    update,
    child,
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

  import {
    getStorage,
    ref as storageRef,
    uploadBytes,
    getDownloadURL,
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
    authDomain: "drfsocial-23a06.firebaseapp.com",
    databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
    projectId: "drfsocial-23a06",
    storageBucket: "drfsocial-23a06.firebasestorage.app",
    messagingSenderId: "608135115201",
    appId: "1:608135115201:web:dc999df2c0f37241ff3f40",
    measurementId: "G-W6VHMP77YR"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const storage = getStorage(app);

  const loginBtn = document.getElementById("loginBtn");
  const resetPasswordBtn = document.getElementById("resetPasswordBtn");
  const authSection = document.getElementById("authSection");
  const userSection = document.getElementById("userSection");

  const avatarEl = document.getElementById("avatar");
  const fullnameEl = document.getElementById("fullname");
  const logoutBtn = document.getElementById("logoutBtn");

  const postForm = document.getElementById("postForm");
  const postText = document.getElementById("postText");
  const mediaFile = document.getElementById("mediaFile");
  const postsDiv = document.getElementById("posts");

  let currentUser = null;

  // Login with Google
  loginBtn.onclick = async () => {
    const provider = new GoogleAuthProvider();
    try {
      const result = await signInWithPopup(auth, provider);
      // User signed in
      currentUser = result.user;
      await checkAndSaveUserData(currentUser);
      updateUIForLoggedInUser();
    } catch (err) {
      alert("Login failed: " + err.message);
    }
  };

  // Password reset by email
  resetPasswordBtn.onclick = async () => {
    const email = prompt("Enter your email to receive a password reset link:");
    if (!email) return;
    try {
      await sendPasswordResetEmail(auth, email);
      alert("Password reset email sent! Please check your inbox.");
    } catch (err) {
      alert("Failed to send reset email: " + err.message);
    }
  };

  logoutBtn.onclick = () => {
    signOut(auth);
  };

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      await checkAndSaveUserData(user);
      updateUIForLoggedInUser();
    } else {
      currentUser = null;
      updateUIForLoggedOutUser();
    }
  });

  async function checkAndSaveUserData(user) {
    // Check if user data exists in DB
    const userRef = ref(db, "profiles/" + user.uid);
    const snapshot = await get(userRef);
    if (!snapshot.exists()) {
      // Save initial profile data
      await set(userRef, {
        fullname: user.displayName || "",
        email: user.email,
        avatarUrl: user.photoURL || ""
      });
    }
  }

  function updateUIForLoggedInUser() {
    authSection.style.display = "none";
    userSection.style.display = "block";

    // Load user profile info
    const userRef = ref(db, "profiles/" + currentUser.uid);
    onValue(userRef, (snapshot) => {
      const data = snapshot.val();
      fullnameEl.textContent = data?.fullname || "No Name";
      avatarEl.src = data?.avatarUrl || "https://via.placeholder.com/80?text=No+Avatar";
    });
  }

  function updateUIForLoggedOutUser() {
    authSection.style.display = "block";
    userSection.style.display = "none";
  }

  // Allow user to edit fullname inline
  fullnameEl.addEventListener("blur", async () => {
    const newName = fullnameEl.textContent.trim();
    if (newName.length === 0) {
      alert("Full name cannot be empty!");
      // Reload from DB to reset display
      const userRef = ref(db, "profiles/" + currentUser.uid + "/fullname");
      const snapshot = await get(userRef);
      fullnameEl.textContent = snapshot.val() || "";
      return;
    }
    // Update fullname in DB
    await update(ref(db, "profiles/" + currentUser.uid), { fullname: newName });
  });

  // Post creation handler
  postForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!currentUser) {
      alert("Please login to post.");
      return;
    }

    const text = postText.value.trim();
    if (!text && !mediaFile.files.length) {
      alert("Please add some text or media.");
      return;
    }

    // Prepare post data
    const postData = {
      userId: currentUser.uid,
      fullname: fullnameEl.textContent,
      avatarUrl: avatarEl.src,
      text,
      timestamp: Date.now(),
      likes: 0,
      comments: {}
    };

    // Upload media if exists
    if (mediaFile.files.length) {
      const file = mediaFile.files[0];
      const ext = file.name.split('.').pop();
      const mediaPath = `posts/${currentUser.uid}/${Date.now()}.${ext}`;
      const mediaStorageRef = storageRef(storage, mediaPath);

      try {
        await uploadBytes(mediaStorageRef, file);
        const mediaURL = await getDownloadURL(mediaStorageRef);
        postData.mediaURL = mediaURL;
        postData.mediaType = file.type.startsWith("video") ? "video" : "image";
      } catch (err) {
        alert("Media upload failed: " + err.message);
        return;
      }
    }

    // Push post to DB
    try {
      const postsRef = ref(db, "posts");
      await push(postsRef, postData);
      postText.value = "";
      mediaFile.value = "";
    } catch (err) {
      alert("Failed to create post: " + err.message);
    }
  });

  // Load posts and listen for new posts
  const postsRef = ref(db, "posts");
  onValue(postsRef, (snapshot) => {
    const postsData = snapshot.val();
    postsDiv.innerHTML = ""; // clear posts

    if (!postsData) {
      postsDiv.textContent = "No posts yet.";
      return;
    }

    // Show newest first
    const postsList = Object.entries(postsData).sort((a,b) => b[1].timestamp - a[1].timestamp);

    postsList.forEach(([postId, post]) => {
      const postEl = document.createElement("div");
      postEl.className = "post";

      let mediaHtml = "";
      if (post.mediaURL) {
        if (post.mediaType === "video") {
          mediaHtml = `<video controls src="${post.mediaURL}"></video>`;
        } else {
          mediaHtml = `<img src="${post.mediaURL}" alt="Post Media" />`;
        }
      }

      postEl.innerHTML = `
        <div style="display:flex; align-items:center;">
          <img src="${post.avatarUrl}" alt="Avatar" style="width:40px; height:40px; border-radius:50%; margin-right:10px;" />
          <strong>${post.fullname}</strong>
        </div>
        <div class="post-text">${post.text ? escapeHtml(post.text) : ""}</div>
        ${mediaHtml}
        <div>
          <span class="reaction-btn" data-postid="${postId}" data-action="like">üëç Like (${post.likes || 0})</span>
          <span class="reaction-btn" data-postid="${postId}" data-action="comment">üí¨ Comment</span>
        </div>
        <div class="comments" id="comments-${postId}"></div>
        <hr/>
      `;

      postsDiv.appendChild(postEl);

      // Load comments
      loadComments(postId, post.comments);
    });
  });

  // Handle likes and comments
  postsDiv.addEventListener("click", async (e) => {
    const target = e.target;
    if (!target.classList.contains("reaction-btn")) return;

    const postId = target.dataset.postid;
    const action = target.dataset.action;

    if (!currentUser) {
      alert("Please login to interact.");
      return;
    }

    if (action === "like") {
      // Increment likes atomically
      const postLikesRef = ref(db, `posts/${postId}/likes`);
      const snapshot = await get(postLikesRef);
      const currentLikes = snapshot.val() || 0;
      await set(postLikesRef, currentLikes + 1);
    } else if (action === "comment") {
      const commentText = prompt("Enter your comment:");
      if (!commentText) return;

      const comment = {
        userId: currentUser.uid,
        fullname: fullnameEl.textContent,
        avatarUrl: avatarEl.src,
        text: commentText,
        timestamp: Date.now()
      };

      // Push comment
      const commentsRef = ref(db, `posts/${postId}/comments`);
      await push(commentsRef, comment);
    }
  });

  function loadComments(postId, comments) {
    const commentsContainer = document.getElementById("comments-" + postId);
    if (!comments) {
      commentsContainer.innerHTML = "";
      return;
    }
    commentsContainer.innerHTML = Object.entries(comments)
      .map(([commentId, c]) => `
        <div style="margin-left:40px; font-size:14px; border-top:1px solid #ddd; padding: 5px 0;">
          <img src="${c.avatarUrl}" style="width:20px; height:20px; border-radius:50%; vertical-align:middle; margin-right:6px;" />
          <strong>${c.fullname}</strong>: ${escapeHtml(c.text)}
        </div>
      `).join("");
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>

</body>
</html>
