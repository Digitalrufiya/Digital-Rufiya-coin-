
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DRF Social</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut,
      signInWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
    import {
      getDatabase,
      ref,
      set,
      push,
      onValue
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";
    import {
      getStorage,
      ref as sRef,
      uploadBytesResumable,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDMsLQtEXbEtzCSl2cl8ht1Qzfwx2tuP4Q",
      authDomain: "drf-token.firebaseapp.com",
      databaseURL: "https://drf-token-default-rtdb.firebaseio.com",
      projectId: "drf-token",
      storageBucket: "drf-token.appspot.com",
      messagingSenderId: "672371217140",
      appId: "1:672371217140:web:730d0ab90d15d3a9a3f878",
      measurementId: "G-Y3EYER10ZX"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);
    const storage = getStorage(app);

    const loginPage = document.getElementById("login-page");
    const profilePage = document.getElementById("profile-page");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const loginBtn = document.getElementById("login-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const userName = document.getElementById("user-name");
    const profilePic = document.getElementById("profile-pic");
    const uploadProfileBtn = document.getElementById("upload-profile");
    const postContent = document.getElementById("post-content");
    const postMedia = document.getElementById("post-media");
    const postBtn = document.getElementById("post-btn");
    const timeline = document.getElementById("timeline");

    const checkUser = () => {
      onAuthStateChanged(auth, (user) => {
        if (user) {
          loginPage.style.display = "none";
          profilePage.style.display = "block";
          userName.textContent = user.email;
          loadProfileImage(user.uid);
          loadPosts();
        } else {
          loginPage.style.display = "block";
          profilePage.style.display = "none";
        }
      });
    };

    const login = () => {
      signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value)
        .then(() => {
          emailInput.value = "";
          passwordInput.value = "";
        })
        .catch((error) => {
          alert("Login error: " + error.message);
        });
    };

    const logout = () => {
      signOut(auth);
    };

    const loadProfileImage = (uid) => {
      getDownloadURL(sRef(storage, "avatars/" + uid))
        .then((url) => {
          profilePic.src = url;
        })
        .catch(() => {
          profilePic.src = "https://via.placeholder.com/150";
        });
    };

    const uploadProfileImage = () => {
      const file = document.getElementById("profile-upload").files[0];
      if (!file) return alert("Please select a file");

      const user = auth.currentUser;
      const storageRef = sRef(storage, "avatars/" + user.uid);
      const uploadTask = uploadBytesResumable(storageRef, file);

      uploadTask.on("state_changed", null, null, () => {
        loadProfileImage(user.uid);
        alert("Profile image updated!");
      });
    };

    const postToTimeline = () => {
      const file = postMedia.files[0];
      const text = postContent.value;
      const user = auth.currentUser;

      if (!text && !file) return alert("Write something or upload media");

      if (file) {
        const mediaRef = sRef(storage, "posts/" + user.uid + "/" + Date.now());
        const uploadTask = uploadBytesResumable(mediaRef, file);

        uploadTask.on("state_changed", null, null, () => {
          getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => {
            const postRef = push(ref(database, "posts"));
            set(postRef, {
              uid: user.uid,
              text: text,
              mediaURL: downloadURL,
              timestamp: Date.now()
            });
            postContent.value = "";
            postMedia.value = "";
            alert("Post uploaded!");
          });
        });
      } else {
        const postRef = push(ref(database, "posts"));
        set(postRef, {
          uid: user.uid,
          text: text,
          timestamp: Date.now()
        });
        postContent.value = "";
        alert("Post uploaded!");
      }
    };

    const loadPosts = () => {
      onValue(ref(database, "posts"), (snapshot) => {
        timeline.innerHTML = "";
        snapshot.forEach((childSnapshot) => {
          const post = childSnapshot.val();
          const postDiv = document.createElement("div");
          postDiv.innerHTML = `
            <p>${post.text || ""}</p>
            ${post.mediaURL ? `<img src="${post.mediaURL}" style="max-width:100%;">` : ""}
            <hr>
          `;
          timeline.prepend(postDiv);
        });
      });
    };

    loginBtn.addEventListener("click", login);
    logoutBtn.addEventListener("click", logout);
    uploadProfileBtn.addEventListener("click", uploadProfileImage);
    postBtn.addEventListener("click", postToTimeline);

    checkUser();
  </script>
</head>
<body>
  <div id="login-page">
    <h2>Login</h2>
    <input type="email" id="email" placeholder="Email"><br>
    <input type="password" id="password" placeholder="Password"><br>
    <button id="login-btn">Login</button>
  </div>

  <div id="profile-page" style="display:none;">
    <h2>Welcome, <span id="user-name"></span></h2>
    <img id="profile-pic" src="" style="width:100px;height:100px;border-radius:50%;"><br>
    <input type="file" id="profile-upload">
    <button id="upload-profile">Upload Profile Pic</button><br><br>

    <textarea id="post-content" placeholder="What's on your mind?"></textarea><br>
    <input type="file" id="post-media"><br>
    <button id="post-btn">Post</button>

    <h3>Timeline</h3>
    <div id="timeline"></div>

    <button id="logout-btn">Logout</button>
  </div>
</body>
</html>
