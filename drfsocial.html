// Render comments HTML
function renderComments(comments = []) {
  if (comments.length === 0) return `<p style="color:#888; font-style:italic;">No comments yet</p>`;
  return comments
    .map(c => `<div class="comment"><strong>${c.username}:</strong> ${c.text}</div>`)
    .join("");
}

// Load posts for user
async function loadUserPosts(uid) {
  postsLoader.style.display = "block";
  postsContainer.innerHTML = "";
  const postsQuery = query(
    collection(db, "posts"),
    where("userId", "==", uid),
    orderBy("createdAt", "desc")
  );
  const querySnapshot = await getDocs(postsQuery);

  if (querySnapshot.empty) {
    postsContainer.innerHTML = "<p style='color:#888; text-align:center;'>No posts yet.</p>";
    postsLoader.style.display = "none";
    return;
  }

  // For each post
  querySnapshot.forEach(async (docSnap) => {
    const post = { id: docSnap.id, ...docSnap.data() };

    // Fetch comments subcollection
    const commentsSnapshot = await getDocs(collection(db, "posts", post.id, "comments"));
    const comments = commentsSnapshot.docs.map(d => d.data());

    // Build post HTML
    const postHTML = `
      <div class="post" id="post-${post.id}">
        <div class="post-header">
          <img src="${post.mediaType === 'video' ? 'https://via.placeholder.com/40?text=Video' : post.userProfilePic || 'https://via.placeholder.com/40?text=User'}" alt="User" />
          <div class="username">${post.username}</div>
        </div>
        <div class="post-text">${post.text || ""}</div>
        ${post.mediaUrl ? `
          <div class="post-media">
            ${post.mediaType === "video" ? `<video src="${post.mediaUrl}" controls></video>` : `<img src="${post.mediaUrl}" alt="Post Image" />`}
          </div>
        ` : ""}
        <div class="reaction-bar">
          ${renderReactions(post)}
        </div>
        <div class="comments">
          ${renderComments(comments)}
          <div class="comment-input">
            <input type="text" placeholder="Write a comment..." data-postid="${post.id}" />
          </div>
        </div>
      </div>
    `;

    postsContainer.insertAdjacentHTML("beforeend", postHTML);
  });
  postsLoader.style.display = "none";

  // Attach event listeners for reactions and comments
  setupInteractionListeners();
}

// Handle reaction clicks
async function handleReactionClick(event) {
  const button = event.target.closest("button.reaction-btn");
  if (!button) return;
  const postId = button.getAttribute("data-postid");
  const reactionType = button.getAttribute("data-reaction");
  if (!postId || !reactionType) return;

  const postRef = doc(db, "posts", postId);

  // Atomically increment reaction count
  try {
    // Read current reactions
    const postSnap = await getDoc(postRef);
    if (!postSnap.exists()) return;

    const postData = postSnap.data();
    const currentReactions = postData.reactions || {};
    currentReactions[reactionType] = (currentReactions[reactionType] || 0) + 1;

    await updateDoc(postRef, { reactions: currentReactions });
    
    // Update UI immediately
    button.querySelector(".count").textContent = currentReactions[reactionType];
  } catch (err) {
    alert("Failed to add reaction: " + err.message);
  }
}

// Handle comment submission
async function handleCommentKeyup(event) {
  if (event.key !== "Enter") return;
  const input = event.target;
  const commentText = input.value.trim();
  if (!commentText) return;
  const postId = input.getAttribute("data-postid");
  if (!postId) return;

  // For demo, fake current user data:
  const currentUser = {
    userId: userId,
    username: profileUsernameEl.textContent,
  };

  try {
    const commentRef = collection(db, "posts", postId, "comments");
    await db.collection("posts").doc(postId).collection("comments").add({
      userId: currentUser.userId,
      username: currentUser.username,
      text: commentText,
      createdAt: Timestamp.now(),
    });

    // Append new comment in UI
    const commentsDiv = input.closest(".comments");
    const newCommentHTML = `<div class="comment"><strong>${currentUser.username}:</strong> ${commentText}</div>`;
    commentsDiv.insertAdjacentHTML("beforeend", newCommentHTML);
    input.value = "";
  } catch (err) {
    alert("Failed to add comment: " + err.message);
  }
}

// Setup event listeners for reactions and comment inputs
function setupInteractionListeners() {
  // Reactions
  document.querySelectorAll("button.reaction-btn").forEach(btn => {
    btn.addEventListener("click", handleReactionClick);
  });
  // Comment inputs
  document.querySelectorAll(".comment-input input").forEach(input => {
    input.addEventListener("keyup", handleCommentKeyup);
  });
}

// Load profile and posts on page load
(async function init() {
  await loadUserProfile(userId);
  await loadUserPosts(userId);
})();
