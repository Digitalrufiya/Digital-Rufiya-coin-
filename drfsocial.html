<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DRF Social</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 0; padding: 0; }
    .post { background: #fff; margin: 16px auto; padding: 16px; border-radius: 8px; max-width: 600px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .post-header { display: flex; align-items: center; margin-bottom: 8px; }
    .post-header img { width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; }
    .username { font-weight: bold; }
    .post-text { margin: 12px 0; }
    .post-media img, .post-media video { max-width: 100%; border-radius: 6px; }
    .reaction-bar { margin-top: 10px; }
    .reaction-btn { cursor: pointer; margin-right: 8px; }
    .comments { margin-top: 10px; }
    .comment-input input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-top: 8px; }
    .comment { margin-top: 6px; font-size: 14px; }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getFirestore, collection, query, where, orderBy, getDocs, doc, getDoc, updateDoc, addDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const userId = "CURRENT_USER_ID"; // Replace with actual auth logic
    const postsContainer = document.createElement("div");
    document.body.appendChild(postsContainer);

    function renderComments(comments = []) {
      if (comments.length === 0) return `<p style="color:#888; font-style:italic;">No comments yet</p>`;
      return comments.map(c => `<div class="comment"><strong>${c.username}:</strong> ${c.text}</div>`).join("");
    }

    async function loadUserPosts(uid) {
      postsContainer.innerHTML = "<p>Loading posts...</p>";
      const postsQuery = query(collection(db, "posts"), where("userId", "==", uid), orderBy("createdAt", "desc"));
      const querySnapshot = await getDocs(postsQuery);

      if (querySnapshot.empty) {
        postsContainer.innerHTML = "<p style='color:#888; text-align:center;'>No posts yet.</p>";
        return;
      }

      postsContainer.innerHTML = "";
      querySnapshot.forEach(async (docSnap) => {
        const post = { id: docSnap.id, ...docSnap.data() };
        const commentsSnapshot = await getDocs(collection(db, "posts", post.id, "comments"));
        const comments = commentsSnapshot.docs.map(d => d.data());

        const postHTML = `
          <div class="post" id="post-${post.id}">
            <div class="post-header">
              <img src="${post.mediaType === 'video' ? 'https://via.placeholder.com/40?text=Video' : post.userProfilePic || 'https://via.placeholder.com/40?text=User'}" alt="User" />
              <div class="username">${post.username}</div>
            </div>
            <div class="post-text">${post.text || ""}</div>
            ${post.mediaUrl ? `
              <div class="post-media">
                ${post.mediaType === "video" ? `<video src="${post.mediaUrl}" controls></video>` : `<img src="${post.mediaUrl}" alt="Post Image" />`}
              </div>
            ` : ""}
            <div class="reaction-bar">
              <button class="reaction-btn" data-postid="${post.id}" data-reaction="like">üëç <span class="count">${(post.reactions && post.reactions.like) || 0}</span></button>
            </div>
            <div class="comments">
              ${renderComments(comments)}
              <div class="comment-input">
                <input type="text" placeholder="Write a comment..." data-postid="${post.id}" />
              </div>
            </div>
          </div>
        `;

        postsContainer.insertAdjacentHTML("beforeend", postHTML);
      });

      setTimeout(setupInteractionListeners, 1000);
    }

    async function handleReactionClick(event) {
      const button = event.target.closest("button.reaction-btn");
      if (!button) return;
      const postId = button.getAttribute("data-postid");
      const reactionType = button.getAttribute("data-reaction");
      const postRef = doc(db, "posts", postId);

      try {
        const postSnap = await getDoc(postRef);
        if (!postSnap.exists()) return;

        const postData = postSnap.data();
        const currentReactions = postData.reactions || {};
        currentReactions[reactionType] = (currentReactions[reactionType] || 0) + 1;

        await updateDoc(postRef, { reactions: currentReactions });
        button.querySelector(".count").textContent = currentReactions[reactionType];
      } catch (err) {
        alert("Failed to react: " + err.message);
      }
    }

    async function handleCommentKeyup(event) {
      if (event.key !== "Enter") return;
      const input = event.target;
      const commentText = input.value.trim();
      if (!commentText) return;
      const postId = input.getAttribute("data-postid");

      const currentUser = {
        userId: userId,
        username: "DemoUser" // Replace with actual username
      };

      try {
        await addDoc(collection(db, "posts", postId, "comments"), {
          userId: currentUser.userId,
          username: currentUser.username,
          text: commentText,
          createdAt: Timestamp.now(),
        });

        const commentsDiv = input.closest(".comments");
        commentsDiv.insertAdjacentHTML("beforeend", `<div class="comment"><strong>${currentUser.username}:</strong> ${commentText}</div>`);
        input.value = "";
      } catch (err) {
        alert("Failed to add comment: " + err.message);
      }
    }

    function setupInteractionListeners() {
      document.querySelectorAll("button.reaction-btn").forEach(btn => {
        btn.removeEventListener("click", handleReactionClick);
        btn.addEventListener("click", handleReactionClick);
      });
      document.querySelectorAll(".comment-input input").forEach(input => {
        input.removeEventListener("keyup", handleCommentKeyup);
        input.addEventListener("keyup", handleCommentKeyup);
      });
    }

    loadUserPosts(userId);
  </script>
</head>
<body>
</body>
</html>
