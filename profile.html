<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DRF Social - User Profile</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    max-width: 400px;
    margin: 30px auto;
    text-align: center;
    background-color: #f0f5f7;
    color: #2c3e50;
  }
  h1 {
    margin-bottom: 10px;
  }
  .avatar {
    width: 150px;
    height: 150px;
    margin: 20px auto;
    border-radius: 50%;
    border: 4px solid #1abc9c;
    object-fit: cover;
    background-color: white;
  }
  input[type="file"],
  input[type="text"] {
    margin-top: 15px;
    padding: 8px;
    font-size: 16px;
    width: 80%;
    border-radius: 5px;
    border: 1px solid #ccc;
  }
  button {
    margin-top: 15px;
    background-color: #1abc9c;
    border: none;
    padding: 10px 20px;
    color: white;
    font-size: 16px;
    border-radius: 6px;
    cursor: pointer;
  }
  button:disabled {
    background-color: #95a5a6;
    cursor: not-allowed;
  }
  #uploadStatus, #authStatus {
    margin-top: 10px;
    font-weight: bold;
  }
  #logoutBtn {
    margin-top: 25px;
    background-color: #e74c3c;
  }
  #loginForm {
    margin-top: 40px;
  }
  #loginForm input {
    display: block;
    margin: 10px auto;
    width: 80%;
  }
</style>
</head>
<body>

<h1>Your Profile</h1>

<div id="authSection">
  <p id="authStatus">Checking auth...</p>
  
  <div id="loginForm" style="display:none;">
    <h2>Login</h2>
    <input type="email" id="emailInput" placeholder="Email" required />
    <input type="password" id="passwordInput" placeholder="Password" required />
    <button id="loginBtn">Login</button>
    <p>Don't have an account? <a href="#" id="showRegister">Register here</a></p>
  </div>

  <div id="registerForm" style="display:none;">
    <h2>Register</h2>
    <input type="email" id="regEmail" placeholder="Email" required />
    <input type="password" id="regPassword" placeholder="Password" required />
    <button id="registerBtn">Register</button>
    <p>Already have an account? <a href="#" id="showLogin">Login here</a></p>
  </div>

  <div id="profileSection" style="display:none;">
    <img id="profileAvatar" class="avatar" alt="User Avatar" src="https://cdn-icons-png.flaticon.com/512/4712/4712027.png" />
    <br />
    <input type="file" id="fileInput" accept="image/*" />
    <br />
    <input type="text" id="fullNameInput" placeholder="Full Name" />
    <br />
    <button id="saveProfileBtn" disabled>Save Profile</button>
    <p id="uploadStatus"></p>
    <button id="logoutBtn">Logout</button>
  </div>
</div>
<!-- Add after profileSection -->
<div id="postSection" style="display:none; margin-top: 40px;">
  <h2>Create a Post</h2>
  <textarea id="postText" placeholder="What's on your mind?" rows="3" style="width: 90%; padding: 8px; border-radius: 5px;"></textarea>
  <br />
  <input type="file" id="postMedia" accept="image/*,video/*" />
  <br />
  <button id="postBtn">Post</button>
  <p id="postStatus"></p>
</div>

<div id="feedSection" style="margin-top: 40px;">
  <h2>Timeline</h2>
  <div id="feed"></div>
</div>

<script type="module">
  import { push, onValue } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

  const postSection = document.getElementById('postSection');
  const feed = document.getElementById('feed');
  const postBtn = document.getElementById('postBtn');
  const postText = document.getElementById('postText');
  const postMedia = document.getElementById('postMedia');
  const postStatus = document.getElementById('postStatus');

  let selectedPostFile = null;
  postMedia.addEventListener('change', e => {
    selectedPostFile = e.target.files[0];
  });

  async function createPost() {
    if (!currentUser) return;
    postStatus.textContent = 'Uploading...';
    postBtn.disabled = true;

    try {
      let mediaUrl = '';
      let mediaType = '';
      if (selectedPostFile) {
        const ext = selectedPostFile.type.startsWith('video/') ? 'video' : 'image';
        mediaType = ext;
        const postRef = ref(storage, `posts/${currentUser.uid}/${Date.now()}_${selectedPostFile.name}`);
        await uploadBytes(postRef, selectedPostFile);
        mediaUrl = await getDownloadURL(postRef);
      }

      const postData = {
        uid: currentUser.uid,
        text: postText.value.trim(),
        mediaUrl,
        mediaType,
        timestamp: Date.now()
      };

      await push(dbRef(database, 'posts'), postData);
      postText.value = '';
      postMedia.value = '';
      selectedPostFile = null;
      postStatus.textContent = 'Posted!';
    } catch (err) {
      postStatus.textContent = 'Post failed: ' + err.message;
    } finally {
      postBtn.disabled = false;
    }
  }

  postBtn.addEventListener('click', createPost);

  function renderPost(postId, post) {
    const postEl = document.createElement('div');
    postEl.style = "background:white;margin:10px;padding:10px;border-radius:10px;text-align:left;";
    postEl.innerHTML = `
      <p>${post.text || ''}</p>
      ${post.mediaUrl && post.mediaType === 'image' ? `<img src="${post.mediaUrl}" style="max-width:100%;border-radius:10px;" />` : ''}
      ${post.mediaUrl && post.mediaType === 'video' ? `<video src="${post.mediaUrl}" controls style="width:100%;border-radius:10px;"></video>` : ''}
      <div style="margin-top: 10px;">
        <button onclick="likePost('${postId}')">‚ù§Ô∏è Like</button>
        <button onclick="commentPost('${postId}')">üí¨ Comment</button>
        <button onclick="sharePost('${postId}')">üîó Share</button>
      </div>
    `;
    feed.prepend(postEl);
  }

  function loadFeed() {
    onValue(dbRef(database, 'posts'), (snapshot) => {
      feed.innerHTML = '';
      const posts = snapshot.val();
      if (posts) {
        const sorted = Object.entries(posts).sort((a, b) => b[1].timestamp - a[1].timestamp);
        sorted.forEach(([id, post]) => renderPost(id, post));
      } else {
        feed.innerHTML = '<p>No posts yet.</p>';
      }
    });
  }

  // Dummy interactions
  window.likePost = (id) => alert(`You liked post ${id}`);
  window.commentPost = (id) => alert(`You clicked comment on post ${id}`);
  window.sharePost = (id) => alert(`You clicked share on post ${id}`);

  // Update UI on login
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      postSection.style.display = 'block';
      loadFeed();
    } else {
      postSection.style.display = 'none';
      feed.innerHTML = '';
    }
  });
</script>
<!-- Firebase SDKs -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-storage.js";
  import { getDatabase, ref as dbRef, set, get, child } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
    authDomain: "drfsocial-23a06.firebaseapp.com",
    databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
    projectId: "drfsocial-23a06",
    storageBucket: "drfsocial-23a06.firebasestorage.app",
    messagingSenderId: "608135115201",
    appId: "1:608135115201:web:b37dffeb550941ffff3f40",
    measurementId: "G-TPT7QMWDYE"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const storage = getStorage(app);
  const database = getDatabase(app);

  // DOM Elements
  const authStatus = document.getElementById('authStatus');
  const profileSection = document.getElementById('profileSection');
  const loginForm = document.getElementById('loginForm');
  const registerForm = document.getElementById('registerForm');
  const emailInput = document.getElementById('emailInput');
  const passwordInput = document.getElementById('passwordInput');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const fileInput = document.getElementById('fileInput');
  const profileAvatar = document.getElementById('profileAvatar');
  const fullNameInput = document.getElementById('fullNameInput');
  const saveProfileBtn = document.getElementById('saveProfileBtn');

  const regEmail = document.getElementById('regEmail');
  const regPassword = document.getElementById('regPassword');
  const registerBtn = document.getElementById('registerBtn');
  const showRegister = document.getElementById('showRegister');
  const showLogin = document.getElementById('showLogin');

  let selectedFile = null;
  let currentUser = null;

  // Show login or register form toggle
  showRegister.addEventListener('click', e => {
    e.preventDefault();
    loginForm.style.display = 'none';
    registerForm.style.display = 'block';
    authStatus.textContent = '';
  });
  showLogin.addEventListener('click', e => {
    e.preventDefault();
    registerForm.style.display = 'none';
    loginForm.style.display = 'block';
    authStatus.textContent = '';
  });

  // Handle Login
  loginBtn.addEventListener('click', () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    if (!email || !password) {
      authStatus.textContent = 'Please enter email and password.';
      return;
    }
    authStatus.textContent = 'Logging in...';
    signInWithEmailAndPassword(auth, email, password)
      .then(() => {
        authStatus.textContent = 'Logged in successfully!';
      })
      .catch(err => {
        authStatus.textContent = 'Login error: ' + err.message;
      });
  });

  // Handle Register
  registerBtn.addEventListener('click', () => {
    const email = regEmail.value.trim();
    const password = regPassword.value.trim();
    if (!email || !password) {
      authStatus.textContent = 'Please enter email and password.';
      return;
    }
    authStatus.textContent = 'Registering...';
    createUserWithEmailAndPassword(auth, email, password)
      .then(() => {
        authStatus.textContent = 'Registered successfully! You can now log in.';
        registerForm.style.display = 'none';
        loginForm.style.display = 'block';
      })
      .catch(err => {
        authStatus.textContent = 'Registration error: ' + err.message;
      });
  });

  // Handle Logout
  logoutBtn.addEventListener('click', () => {
    signOut(auth);
  });

  // Enable Save button if name or file selected
  function updateSaveBtnState() {
    saveProfileBtn.disabled = !fullNameInput.value.trim() && !selectedFile;
  }

  fullNameInput.addEventListener('input', updateSaveBtnState);
  fileInput.addEventListener('change', e => {
    selectedFile = e.target.files[0];
    updateSaveBtnState();
  });

  // Save profile data (upload avatar if selected + save full name)
  saveProfileBtn.addEventListener('click', async () => {
    if (!currentUser) return;

    saveProfileBtn.disabled = true;
    authStatus.textContent = 'Saving profile...';

    try {
      let avatarUrl = profileAvatar.src; // current avatar

      if (selectedFile) {
        // Upload new avatar
        const avatarRef = ref(storage, 'profiles/' + currentUser.uid + '/' + selectedFile.name);
        await uploadBytes(avatarRef, selectedFile);
        avatarUrl = await getDownloadURL(avatarRef);
      }

      // Save profile info to Realtime DB
      await set(dbRef(database, 'users/' + currentUser.uid), {
        fullName: fullNameInput.value.trim(),
        avatar: avatarUrl
      });

      profileAvatar.src = avatarUrl;
      authStatus.textContent = 'Profile saved successfully!';
      selectedFile = null;
      fileInput.value = '';
      updateSaveBtnState();

    } catch (err) {
      authStatus.textContent = 'Error saving profile: ' + err.message;
    } finally {
      saveProfileBtn.disabled = false;
    }
  });

  // Listen for auth state changes
  onAuthStateChanged(auth, async (user) => {
    currentUser = user;
    if (user) {
      // Hide login/register forms, show profile
      loginForm.style.display = 'none';
      registerForm.style.display = 'none';
      profileSection.style.display = 'block';
      authStatus.textContent = `Welcome, ${user.email}`;

      // Load profile info from database
      const snapshot = await get(child(dbRef(database), 'users/' + user.uid));
      if (snapshot.exists()) {
        const data = snapshot.val();
        fullNameInput.value = data.fullName || '';
        profileAvatar.src = data.avatar || profileAvatar.src;
      } else {
        // Defaults if no profile yet
        fullNameInput.value = '';
        profileAvatar.src = 'https://cdn-icons-png.flaticon.com/512/4712/4712027.png';
      }

      updateSaveBtnState();

    } else {
      // No user logged in, show login form
      profileSection.style.display = 'none';
      registerForm.style.display = 'none';
      loginForm.style.display = 'block';
      authStatus.textContent = 'Please log in.';
    }
  });
</script>
</body>
</html>
<!-- CONTINUED SCRIPT FROM WHERE YOU LEFT OFF -->
      .then(() => {
        authStatus.textContent = 'Logged in successfully!';
      })
      .catch(error => {
        authStatus.textContent = 'Login failed: ' + error.message;
      });
  });

  // Handle Register
  registerBtn.addEventListener('click', () => {
    const email = regEmail.value.trim();
    const password = regPassword.value.trim();
    if (!email || !password) {
      authStatus.textContent = 'Please enter email and password.';
      return;
    }
    authStatus.textContent = 'Registering...';
    createUserWithEmailAndPassword(auth, email, password)
      .then(() => {
        authStatus.textContent = 'Registered successfully!';
      })
      .catch(error => {
        authStatus.textContent = 'Registration failed: ' + error.message;
      });
  });

  // Handle Logout
  logoutBtn.addEventListener('click', () => {
    signOut(auth);
  });

  // File input for profile image
  fileInput.addEventListener('change', e => {
    selectedFile = e.target.files[0];
    saveProfileBtn.disabled = !selectedFile && !fullNameInput.value.trim();
  });

  fullNameInput.addEventListener('input', () => {
    saveProfileBtn.disabled = !selectedFile && !fullNameInput.value.trim();
  });

  // Save Profile
  saveProfileBtn.addEventListener('click', async () => {
    if (!currentUser) return;
    saveProfileBtn.disabled = true;
    uploadStatus.textContent = 'Saving...';

    try {
      let photoURL = profileAvatar.src;
      if (selectedFile) {
        const storageRef = ref(storage, `avatars/${currentUser.uid}`);
        await uploadBytes(storageRef, selectedFile);
        photoURL = await getDownloadURL(storageRef);
      }

      const fullName = fullNameInput.value.trim();

      const userRef = dbRef(database, `users/${currentUser.uid}`);
      await set(userRef, {
        fullName,
        photoURL
      });

      profileAvatar.src = photoURL;
      uploadStatus.textContent = 'Profile updated!';
      selectedFile = null;
      fullNameInput.value = '';
    } catch (error) {
      uploadStatus.textContent = 'Error: ' + error.message;
    } finally {
      saveProfileBtn.disabled = false;
    }
  });

  // Load user data
  async function loadUserProfile(uid) {
    try {
      const snapshot = await get(child(dbRef(database), `users/${uid}`));
      if (snapshot.exists()) {
        const data = snapshot.val();
        if (data.photoURL) profileAvatar.src = data.photoURL;
        if (data.fullName) fullNameInput.placeholder = data.fullName;
      }
    } catch (err) {
      console.error('Error loading profile:', err);
    }
  }

  // On auth state change
  onAuthStateChanged(auth, user => {
    if (user) {
      currentUser = user;
      authStatus.textContent = '';
      loginForm.style.display = 'none';
      registerForm.style.display = 'none';
      profileSection.style.display = 'block';
      postSection.style.display = 'block';
      loadFeed();
      loadUserProfile(user.uid);
    } else {
      currentUser = null;
      profileSection.style.display = 'none';
      postSection.style.display = 'none';
      loginForm.style.display = 'block';
      feed.innerHTML = '';
      authStatus.textContent = 'Please log in or register.';
    }
  });
</script>

</body>
</html>

