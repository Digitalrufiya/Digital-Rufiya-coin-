<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Create / Update Profile</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 500px; margin: 20px auto; }
  label { display: block; margin-top: 15px; }
  input, select { width: 100%; padding: 8px; margin-top: 5px; }
  button { margin-top: 20px; padding: 10px 20px; }
  img#preview { margin-top: 10px; max-width: 150px; max-height: 150px; object-fit: cover; border-radius: 50%; }
  .message { margin-top: 15px; color: green; }
  .error { color: red; }
</style>
</head>
<body>

<h2>Create / Update Profile</h2>

<form id="profileForm">
  <label>Profile Photo (jpg/png):</label>
  <input type="file" id="photoInput" accept="image/*" required />
  <img id="preview" src="" alt="Profile Preview" style="display:none;" />

  <label>Name:</label>
  <input type="text" id="nameInput" required />

  <label>Wallet Address (required):</label>
  <input type="text" id="walletInput" placeholder="0x..." pattern="0x[a-fA-F0-9]{40}" required />

  <label>Country:</label>
  <input type="text" id="countryInput" />

  <label>Gender:</label>
  <select id="genderInput">
    <option value="">Select gender</option>
    <option>Male</option>
    <option>Female</option>
    <option>Other</option>
  </select>

  <label>Age:</label>
  <input type="number" id="ageInput" min="1" max="120" />

  <button type="submit">Save Profile</button>
</form>

<div class="message" id="message"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
    authDomain: "drfsocial-23a06.firebaseapp.com",
    databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
    projectId: "drfsocial-23a06",
    storageBucket: "drfsocial-23a06.firebasestorage.app",
    messagingSenderId: "608135115201",
    appId: "1:608135115201:web:dc999df2c0f37241ff3f40",
    measurementId: "G-W6VHMP77YR"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Pinata JWT Token (put your own here)
  const PINATA_JWT = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI4MDFmMDAxNy04YjZkLTQ2YjYtOGIwZi04Y2NkZWU5NzE4ODIiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWFAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInBpbl9wb2xpY3kiOnsicmVnaW9ucyI6W3siZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiRlJBMSJ9LHsiZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiTllDMSJ9XSwidmVyc2lvbiI6MX0sIm1mYV9lbmFibGVkIjpmYWxzZSwic3RhdHVzIjoiQUNUSVZFIn0sImF1dGhlbnRpY2F0aW9uVHlwZSI6InNjb3BlZEtleSIsInNjb3BlZEtleUtleSI6IjNkODdmOWVkOTA0ZGY4OTI2NTRjIiwic2NvcGVkS2V5U2VjcmV0IjoiYTI3OWU4ODU0ZDQ0YWY2Y2IxNzA0N2RhOThhYTc3MmExOTAyMmFhYTIwOTQ5YjEzN2Y5ZmIxMDI3YzAzYmY5ZiIsImV4cCI6MTc4MDQyMzA3Mn0.YpqewbjW7gAVyPSKYiO9Ym9QhddKc_1vm8CJIoXDQyA";

  const photoInput = document.getElementById("photoInput");
  const previewImg = document.getElementById("preview");
  const nameInput = document.getElementById("nameInput");
  const walletInput = document.getElementById("walletInput");
  const countryInput = document.getElementById("countryInput");
  const genderInput = document.getElementById("genderInput");
  const ageInput = document.getElementById("ageInput");
  const messageDiv = document.getElementById("message");

  // Preview uploaded photo
  photoInput.addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) {
      previewImg.style.display = "none";
      return;
    }
    const reader = new FileReader();
    reader.onload = function(ev) {
      previewImg.src = ev.target.result;
      previewImg.style.display = "block";
    };
    reader.readAsDataURL(file);
  });

  // Upload photo to Pinata
  async function uploadPhotoToPinata(file) {
    const url = "https://api.pinata.cloud/pinning/pinFileToIPFS";
    const data = new FormData();
    data.append("file", file);

    const res = await fetch(url, {
      method: "POST",
      headers: {
        Authorization: `Bearer ${PINATA_JWT}`
      },
      body: data
    });

    if (!res.ok) throw new Error("Pinata upload failed");
    const json = await res.json();
    return `https://gateway.pinata.cloud/ipfs/${json.IpfsHash}`;
  }

  // Save profile data to Firebase DB
  async function saveProfile(profile) {
    const walletKey = profile.wallet.toLowerCase();
    await set(ref(db, `profiles/${walletKey}`), profile);
  }

  // Load profile if exists
  async function loadProfile(wallet) {
    const snapshot = await get(child(ref(db), `profiles/${wallet.toLowerCase()}`));
    if (snapshot.exists()) {
      return snapshot.val();
    }
    return null;
  }

  // On form submit
  document.getElementById("profileForm").addEventListener("submit", async e => {
    e.preventDefault();
    messageDiv.textContent = "";
    try {
      if (!walletInput.value.match(/^0x[a-fA-F0-9]{40}$/)) {
        messageDiv.textContent = "Invalid wallet address format.";
        messageDiv.className = "error";
        return;
      }
      messageDiv.textContent = "Uploading photo...";

      const file = photoInput.files[0];
      if (!file) {
        messageDiv.textContent = "Please select a profile photo.";
        messageDiv.className = "error";
        return;
      }
      const photoUrl = await uploadPhotoToPinata(file);

      const profileData = {
        photoUrl,
        name: nameInput.value.trim(),
        wallet: walletInput.value.trim().toLowerCase(),
        country: countryInput.value.trim(),
        gender: genderInput.value,
        age: ageInput.value ? parseInt(ageInput.value) : null,
        updatedAt: Date.now()
      };

      await saveProfile(profileData);
      messageDiv.textContent = "Profile successfully saved!";
      messageDiv.className = "message";
    } catch (error) {
      messageDiv.textContent = "Error: " + error.message;
      messageDiv.className = "error";
    }
  });

  // Auto-fill form if wallet entered and profile exists
  walletInput.addEventListener("blur", async () => {
    const wallet = walletInput.value.trim().toLowerCase();
    if (!wallet.match(/^0x[a-fA-F0-9]{40}$/)) return;

    messageDiv.textContent = "Loading profile...";
    const profile = await loadProfile(wallet);
    if (profile) {
      nameInput.value = profile.name || "";
      countryInput.value = profile.country || "";
      genderInput.value = profile.gender || "";
      ageInput.value = profile.age || "";
      previewImg.src = profile.photoUrl || "";
      previewImg.style.display = profile.photoUrl ? "block" : "none";
      messageDiv.textContent = "Profile loaded. You can update now.";
      messageDiv.className = "message";
    } else {
      messageDiv.textContent = "No profile found. You can create a new one.";
      messageDiv.className = "";
      previewImg.style.display = "none";
      nameInput.value = "";
      countryInput.value = "";
      genderInput.value = "";
      ageInput.value = "";
    }
  });
</script>

</body>
</html>
