<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Profile | DRF Wallet</title>
  <link href="style.css" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal">

  <div class="max-w-4xl mx-auto mt-10 p-6 bg-white rounded-lg shadow-lg">
    <div class="relative">
      <!-- Cover Photo with Public URL -->
      <img id="coverPicPreview" class="w-full h-48 object-cover rounded-lg"
           src="https://i.imgur.com/3ZQ3Z7Z.jpg" alt="Cover Photo"/>

      <!-- Avatar with Public URL -->
      <div class="absolute left-4 -bottom-12 w-24 h-24">
        <img id="profilePicPreview" class="w-24 h-24 object-cover rounded-full border-4 border-white"
             src="https://i.imgur.com/5tj6S7O.png" alt="Profile Picture"/>
      </div>
    </div>

    <div class="mt-16 text-center">
      <h1 id="userName" class="text-2xl font-bold text-gray-800">Loading...</h1>
      <p id="userEmail" class="text-gray-600">Loading...</p>
    </div>

    <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block text-gray-700 font-medium mb-1">Change Profile Picture</label>
        <input type="file" id="profilePic" accept="image/*"
               class="w-full border border-gray-300 rounded px-3 py-2"/>
      </div>

      <div>
        <label class="block text-gray-700 font-medium mb-1">Change Cover Photo</label>
        <input type="file" id="coverPic" accept="image/*"
               class="w-full border border-gray-300 rounded px-3 py-2"/>
      </div>
    </div>

    <div class="mt-6 text-center">
      <button id="saveProfile"
              class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded">
        Save Changes
      </button>
    </div>
  </div>

  <script>
    // Firebase Config (Replace with your own)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DB_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const profilePicInput = document.getElementById("profilePic");
    const coverPicInput = document.getElementById("coverPic");
    const profilePreview = document.getElementById("profilePicPreview");
    const coverPreview = document.getElementById("coverPicPreview");
    const userName = document.getElementById("userName");
    const userEmail = document.getElementById("userEmail");

    window.onload = () => {
      auth.onAuthStateChanged(user => {
        if (user) {
          userEmail.textContent = user.email;

          const safeUID = user.uid.replace(/[.#$[\]]/g, "_");
          const userRef = db.ref("users/" + safeUID);

          userRef.once("value").then(snapshot => {
            const data = snapshot.val();
            if (data) {
              userName.textContent = data.name || "Unnamed";
              if (data.profilePic) profilePreview.src = data.profilePic;
              if (data.coverPic) coverPreview.src = data.coverPic;
            }
          });

          document.getElementById("saveProfile").onclick = () => {
            const reader1 = new FileReader();
            const reader2 = new FileReader();
            const updates = {};

            reader1.onload = () => {
              updates.profilePic = reader1.result;
              checkAndSave();
            };
            reader2.onload = () => {
              updates.coverPic = reader2.result;
              checkAndSave();
            };

            let pending = 0;
            function checkAndSave() {
              pending--;
              if (pending <= 0) {
                userRef.update(updates)
                  .then(() => alert("Profile updated successfully."))
                  .catch(err => alert("Error updating profile: " + err.message));
              }
            }

            pending = 0;
            if (profilePicInput.files[0]) {
              pending++;
              reader1.readAsDataURL(profilePicInput.files[0]);
            }
            if (coverPicInput.files[0]) {
              pending++;
              reader2.readAsDataURL(coverPicInput.files[0]);
            }

            if (pending === 0) {
              alert("No changes made.");
            }
          };

        } else {
          window.location.href = "login.html"; // or wherever your login page is
        }
      });
    };
  </script>
</body>
</html>
