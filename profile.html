<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Profile Uploader</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    input, textarea, button {
      display: block;
      margin: 10px 0;
      padding: 10px;
      width: 100%;
      max-width: 400px;
    }
    .profile-display {
      margin-top: 20px;
      border: 1px solid #ccc;
      padding: 20px;
      max-width: 400px;
    }
    img {
      max-width: 100%;
      height: auto;
    }
  </style>
</head>
<body>

<h2>Upload Profile to IPFS</h2>

<input type="text" id="name" placeholder="Enter your name" required />
<input type="text" id="gender" placeholder="Male or Female" required />
<input type="number" id="age" placeholder="Enter your age" min="1" required />
<textarea id="bio" rows="3" placeholder="Enter your bio" required></textarea>
<input type="text" id="wallet" placeholder="Enter your wallet address" required />
<input type="file" id="image" accept="image/*" required />
<button id="uploadBtn">Upload Profile</button>

<div class="profile-display" style="display:none;">
  <h3>Profile Info</h3>
  <img id="displayImage" />
  <p><strong>Name:</strong> <span id="displayName"></span></p>
  <p><strong>Gender:</strong> <span id="displayGender"></span></p>
  <p><strong>Age:</strong> <span id="displayAge"></span></p>
  <p><strong>Bio:</strong> <span id="displayBio"></span></p>
  <p><strong>Wallet:</strong> <span id="displayWallet"></span></p>
  <button id="editBtn">Edit Profile</button>
</div>

<script>
const uploadBtn = document.getElementById('uploadBtn');
const imageInput = document.getElementById('image');
const nameInput = document.getElementById('name');
const genderInput = document.getElementById('gender');
const ageInput = document.getElementById('age');
const bioInput = document.getElementById('bio');
const walletInput = document.getElementById('wallet');

const PINATA_JWT = "Bearer YOUR_PINATA_JWT_HERE"; // Replace with your actual JWT

uploadBtn.addEventListener('click', async () => {
  const name = nameInput.value.trim();
  const gender = genderInput.value.trim();
  const age = parseInt(ageInput.value.trim());
  const bio = bioInput.value.trim();
  const wallet = walletInput.value.trim();
  const file = imageInput.files[0];

  if (!name || !bio || !wallet || !file || !gender || !age) {
    alert('Please fill in all fields');
    return;
  }

  try {
    // 1. Upload image to IPFS
    const formData = new FormData();
    formData.append("file", file);

    const imgRes = await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS", {
      method: "POST",
      headers: {
        Authorization: PINATA_JWT
      },
      body: formData
    });

    const imgData = await imgRes.json();
    const imageUrl = `https://gateway.pinata.cloud/ipfs/${imgData.IpfsHash}`;

    // 2. Upload profile JSON
    const profileData = {
      name,
      gender,
      age,
      bio,
      wallet,
      image: imageUrl,
      updated: new Date().toISOString()
    };

    const jsonRes = await fetch("https://api.pinata.cloud/pinning/pinJSONToIPFS", {
      method: "POST",
      headers: {
        Authorization: PINATA_JWT,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        pinataContent: profileData,
        pinataMetadata: { name: `${wallet}_profile` }
      })
    });

    const jsonData = await jsonRes.json();
    const jsonUrl = `https://gateway.pinata.cloud/ipfs/${jsonData.IpfsHash}`;

    alert("Profile uploaded successfully!");

    showProfile(profileData);
    localStorage.setItem("profile", JSON.stringify(profileData));
  } catch (err) {
    console.error("Upload failed:", err);
    alert("Upload failed. Check console.");
  }
});

function showProfile(profile) {
  document.querySelector(".profile-display").style.display = "block";
  document.getElementById("displayImage").src = profile.image;
  document.getElementById("displayName").innerText = profile.name;
  document.getElementById("displayGender").innerText = profile.gender;
  document.getElementById("displayAge").innerText = profile.age;
  document.getElementById("displayBio").innerText = profile.bio;
  document.getElementById("displayWallet").innerText = profile.wallet;
}

// Edit button: repopulate form
document.getElementById("editBtn").addEventListener("click", () => {
  const profile = JSON.parse(localStorage.getItem("profile"));
  if (profile) {
    nameInput.value = profile.name || '';
    genderInput.value = profile.gender || '';
    ageInput.value = profile.age || '';
    bioInput.value = profile.bio || '';
    walletInput.value = profile.wallet || '';
    window.scrollTo({ top: 0, behavior: "smooth" });
  }
});

// Load saved profile on page load
window.onload = () => {
  const saved = localStorage.getItem("profile");
  if (saved) {
    const profile = JSON.parse(saved);
    showProfile(profile);
  }
};
</script>

</body>
</html>
