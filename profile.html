<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DRF Media Timeline with Profiles & Infinite Scroll</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background: #f0f2f5;
  }
  h1 {
    text-align: center;
    margin-bottom: 25px;
  }
  form {
    max-width: 600px;
    margin: 10px auto 30px;
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 3px 10px rgb(0 0 0 / 0.1);
  }
  label {
    display: block;
    margin-bottom: 6px;
    font-weight: bold;
  }
  input[type=text], input[type=file], textarea {
    width: 100%;
    padding: 8px 10px;
    margin-bottom: 15px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 15px;
  }
  textarea {
    resize: vertical;
  }
  button {
    padding: 10px 22px;
    border: none;
    background: #0066cc;
    color: white;
    border-radius: 6px;
    font-size: 16px;
    cursor: pointer;
  }
  button:disabled {
    background: #999;
    cursor: not-allowed;
  }
  #profilePicPreview {
    display: block;
    width: 100px;
    height: 100px;
    margin-bottom: 12px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #0066cc;
  }
  #postContainer {
    max-width: 700px;
    margin: 0 auto 40px;
  }
  .post-item {
    background: white;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 10px;
    box-shadow: 0 1px 5px rgb(0 0 0 / 0.1);
  }
  .post-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 10px;
  }
  .post-header img {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    object-fit: cover;
    border: 1px solid #ccc;
  }
  .post-header .user-info {
    font-weight: bold;
    font-size: 16px;
  }
  .post-header .wallet-address {
    font-weight: normal;
    font-size: 12px;
    color: #555;
  }
  .post-caption {
    margin: 10px 0;
    font-size: 16px;
  }
  .post-time {
    font-size: 12px;
    color: #555;
    margin-bottom: 8px;
  }
  .post-item img,
  .post-item video {
    max-width: 100%;
    border-radius: 8px;
    margin-top: 5px;
  }
  #loadMoreBtn {
    display: block;
    margin: 20px auto 40px;
    padding: 10px 30px;
    font-size: 16px;
    border-radius: 6px;
    border: none;
    background: #0066cc;
    color: white;
    cursor: pointer;
  }
  #loadMoreBtn:disabled {
    background: #999;
    cursor: not-allowed;
  }
  .section-title {
    text-align: center;
    font-weight: 700;
    font-size: 22px;
    margin-top: 50px;
    margin-bottom: 15px;
    color: #333;
  }
</style>
</head>
<body>

<h1>DRF Media Timeline with Profiles & Infinite Scroll</h1>

<!-- User Profile Form -->
<form id="profileForm">
  <div><strong>User Profile Setup</strong></div>
  <label for="userName">Name</label>
  <input type="text" id="userName" placeholder="Your name" required />

  <label for="walletAddress">Wallet Address (manually enter)</label>
  <input type="text" id="walletAddress" placeholder="Your wallet address" required />

  <label for="profilePic">Profile Picture</label>
  <input type="file" id="profilePic" accept="image/*" />
  <img id="profilePicPreview" src="" alt="Profile Preview" style="display:none;" />

  <button type="submit">Save Profile</button>
</form>

<!-- Post Form -->
<form id="postForm">
  <div><strong>Create a Post</strong></div>
  <label for="postMedia">Upload Image or Video</label>
  <input type="file" id="postMedia" accept="image/*,video/*" required />

  <label for="postCaption">Caption</label>
  <textarea id="postCaption" placeholder="Write your caption..." required></textarea>

  <button type="submit">Post</button>
</form>

<!-- Posts Timeline -->
<h2 class="section-title">Timeline</h2>
<div id="postContainer"></div>
<button id="loadMoreBtn">Load More Posts</button>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import {
    getDatabase,
    ref,
    push,
    query,
    orderByChild,
    limitToLast,
    endAt,
    get,
    set,
    onValue
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

  // ======= Your Firebase Config ========
  const firebaseConfig = {
    apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
    authDomain: "drfsocial-23a06.firebaseapp.com",
    databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
    projectId: "drfsocial-23a06",
    storageBucket: "drfsocial-23a06.appspot.com",
    messagingSenderId: "608135115201",
    appId: "1:608135115201:web:dc999df2c0f37241ff3f40",
    measurementId: "G-W6VHMP77YR"
  };

  // Pinata JWT (replace with your own)
  const PINATA_JWT = "<YOUR_PINATA_JWT_HERE>";

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Profile elements
  const profileForm = document.getElementById('profileForm');
  const userNameInput = document.getElementById('userName');
  const walletAddressInput = document.getElementById('walletAddress');
  const profilePicInput = document.getElementById('profilePic');
  const profilePicPreview = document.getElementById('profilePicPreview');

  // Post elements
  const postForm = document.getElementById('postForm');
  const postMediaInput = document.getElementById('postMedia');
  const postCaptionInput = document.getElementById('postCaption');

  // Timeline elements
  const postContainer = document.getElementById('postContainer');
  const loadMoreBtn = document.getElementById('loadMoreBtn');

  // Store last loaded timestamp for pagination
  let lastLoadedTimestamp = null;
  const POSTS_BATCH_SIZE = 5;

  // Store current user profile data in-memory
  let currentUserProfile = null;

  // Profile pic preview on file select
  profilePicInput.addEventListener('change', () => {
    const file = profilePicInput.files[0];
    if (!file) {
      profilePicPreview.style.display = 'none';
      profilePicPreview.src = '';
      return;
    }
    const reader = new FileReader();
    reader.onload = (e) => {
      profilePicPreview.src = e.target.result;
      profilePicPreview.style.display = 'block';
    };
    reader.readAsDataURL(file);
  });

  // Save profile to Firebase DB
  profileForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const name = userNameInput.value.trim();
    const wallet = walletAddressInput.value.trim().toLowerCase();
    if (!name || !wallet) return alert("Name and Wallet Address are required.");

    profileForm.querySelector('button').disabled = true;
    profileForm.querySelector('button').textContent = 'Saving...';

    try {
      let profilePicUrl = null;

      // If profile pic selected, upload to Pinata
      if (profilePicInput.files[0]) {
        profilePicUrl = await uploadToPinata(profilePicInput.files[0]);
      }

      const profileData = {
        name,
        wallet,
        profilePicUrl: profilePicUrl || "",
        updatedAt: Date.now()
      };

      // Save profile under users/{wallet}
      await set(ref(db, `users/${wallet}`), profileData);

      alert("Profile saved successfully!");
      currentUserProfile = profileData;
    } catch (err) {
      alert("Error saving profile: " + err.message);
    } finally {
      profileForm.querySelector('button').disabled = false;
      profileForm.querySelector('button').textContent = 'Save Profile';
    }
  });

  // Upload to Pinata helper
  async function uploadToPinata(file) {
    const url = `https://api.pinata.cloud/pinning/pinFileToIPFS`;
    const data = new FormData();
    data.append('file', file);

    const res = await fetch(url, {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${PINATA_JWT}`
      },
      body: data
    });
    if (!res.ok) throw new Error('Pinata upload failed');
    const json = await res.json();
    return `https://gateway.pinata.cloud/ipfs/${json.IpfsHash}`;
  }

  // Create new post handler
  postForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!currentUserProfile) {
      return alert('Please save your profile first!');
    }

    const file = postMediaInput.files[0];
    const caption = postCaptionInput.value.trim();
    if (!file || !caption) return alert("Media file and caption are required.");

    postForm.querySelector('button').disabled = true;
    postForm.querySelector('button').textContent = 'Posting...';

    try {
      // Upload media to Pinata
      const mediaUrl = await uploadToPinata(file);

      // Determine media type for display
      const mediaType = file.type.startsWith('video/') ? 'video' : 'image';

      // Prepare post object
      const postData = {
        wallet: currentUserProfile.wallet,
        name: currentUserProfile.name,
        profilePicUrl: currentUserProfile.profilePicUrl || "",
        mediaUrl,
        mediaType,
        caption,
        timestamp: Date.now()
      };

      // Push to posts node
      await push(ref(db, 'posts'), postData);

      alert('Post created successfully!');

      // Clear post form
      postForm.reset();
      postCaptionInput.value = '';
      postMediaInput.value = '';

      // Refresh timeline to show new post immediately
      resetTimeline();
      loadPosts();

    } catch (err) {
      alert("Error posting: " + err.message);
    } finally {
      postForm.querySelector('button').disabled = false;
      postForm.querySelector('button').textContent = 'Post';
    }
  });

  // Load posts batch
  async function loadPosts() {
    loadMoreBtn.disabled = true;
    loadMoreBtn.textContent = 'Loading...';

    try {
      let postsQuery;

      if (lastLoadedTimestamp === null) {
        // First load: get last POSTS_BATCH_SIZE posts
        postsQuery = query(
          ref(db, 'posts'),
          orderByChild('timestamp'),
          limitToLast(POSTS_BATCH_SIZE)
        );
      } else {
        // Load older posts with timestamp < lastLoadedTimestamp
        postsQuery = query(
          ref(db, 'posts'),
          orderByChild('timestamp'),
          endAt(lastLoadedTimestamp - 1),
          limitToLast(POSTS_BATCH_SIZE)
        );
      }

      const snapshot = await get(postsQuery);
      if (!snapshot.exists()) {
        loadMoreBtn.style.display = 'none';
        return;
      }

      // Convert snapshot to array and sort descending
      const postsArray = [];
      snapshot.forEach(childSnap => {
        postsArray.push({ id: childSnap.key, ...childSnap.val() });
      });

      if (postsArray.length === 0) {
        loadMoreBtn.style.display = 'none';
        return;
      }

      postsArray.sort((a, b) => b.timestamp - a.timestamp);

      // Update lastLoadedTimestamp to oldest post's timestamp
      lastLoadedTimestamp = postsArray[postsArray.length - 1].timestamp;

      // Append posts to container
      for (const post of postsArray) {
        appendPost(post);
      }

      loadMoreBtn.disabled = false;
      loadMoreBtn.textContent = 'Load More Posts';

    } catch (err) {
      alert("Error loading posts: " + err.message);
      loadMoreBtn.disabled = false;
      loadMoreBtn.textContent = 'Load More Posts';
    }
  }

  // Append single post to timeline
  function appendPost(post) {
    const div = document.createElement('div');
    div.className = 'post-item';

    const timeStr = new Date(post.timestamp).toLocaleString();

    div.innerHTML = `
      <div class="post-header">
        <img src="${post.profilePicUrl || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}" alt="Profile Pic" />
        <div>
          <div class="user-info">${escapeHtml(post.name)}</div>
          <div class="wallet-address">${escapeHtml(post.wallet)}</div>
        </div>
      </div>
      <div class="post-caption">${escapeHtml(post.caption)}</div>
      <div class="post-time">${timeStr}</div>
      ${post.mediaType === 'video' ?
        `<video controls src="${post.mediaUrl}"></video>` :
        `<img src="${post.mediaUrl}" alt="Post media" />`
      }
    `;

    postContainer.appendChild(div);
  }

  // Escape html for safety
  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, (m) => {
      switch(m) {
        case '&': return '&amp;';
        case '<': return '&lt;';
        case '>': return '&gt;';
        case '"': return '&quot;';
        case "'": return '&#39;';
        default: return m;
      }
    });
  }

  // Reset timeline to initial state
  function resetTimeline() {
    postContainer.innerHTML = '';
    lastLoadedTimestamp = null;
    loadMoreBtn.style.display = 'block';
  }

  // Load more button
  loadMoreBtn.addEventListener('click', () => {
    loadPosts();
  });

  // Load initial posts on page load
  window.addEventListener('load', () => {
    resetTimeline();
    loadPosts();
  });

</script>
</body>
</html>
