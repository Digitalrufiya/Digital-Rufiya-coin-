<!-- Minimal HTML -->
<form id="uploadForm">
  <input type="file" id="mediaFile" required />
  <input type="text" id="caption" placeholder="Caption" required />
  <button type="submit">Upload</button>
</form>

<div id="result"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

  // Firebase config - FIXED bucket URL
  const firebaseConfig = {
    apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
    authDomain: "drfsocial-23a06.firebaseapp.com",
    databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
    projectId: "drfsocial-23a06",
    storageBucket: "drfsocial-23a06.appspot.com",
    messagingSenderId: "608135115201",
    appId: "1:608135115201:web:dc999df2c0f37241ff3f40",
    measurementId: "G-W6VHMP77YR"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Your Pinata JWT (replace with your actual JWT)
  const PINATA_JWT = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI4MDFmMDAxNy04YjZkLTQ2YjYtOGIwZi04Y2NkZWU5NzE4ODIiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWFAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInBpbl9wb2xpY3kiOnsicmVnaW9ucyI6W3siZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiRlJBMSJ9LHsiZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiTllDMSJ9XSwidmVyc2lvbiI6MX0sIm1mYV9lbmFibGVkIjpmYWxzZSwic3RhdHVzIjoiQUNUSVZFIn0sImF1dGhlbnRpY2F0aW9uVHlwZSI6InNjb3BlZEtleSIsInNjb3BlZEtleUtleSI6IjNkODdmOWVkOTA0ZGY4OTI2NTRjIiwic2NvcGVkS2V5U2VjcmV0IjoiYTI3OWU4ODU0ZDQ0YWY2Y2IxNzA0N2RhOThhYTc3MmExOTAyMmFhYTIwOTQ5YjEzN2Y5ZmIxMDI3YzAzYmY5ZiIsImV4cCI6MTc4MDQyMzA3Mn0.YpqewbjW7gAVyPSKYiO9Ym9QhddKc_1vm8CJIoXDQyA";

  const uploadForm = document.getElementById('uploadForm');
  const mediaFileInput = document.getElementById('mediaFile');
  const captionInput = document.getElementById('caption');
  const resultDiv = document.getElementById('result');

  async function uploadToPinata(file) {
    const url = `https://api.pinata.cloud/pinning/pinFileToIPFS`;
    const formData = new FormData();
    formData.append('file', file);

    // Add metadata JSON - you can customize this
    const metadata = {
      name: file.name,
      keyvalues: {
        uploadedBy: "digitalrufiya@gmail.com",
        description: "File uploaded from DRF app"
      }
    };
    formData.append('pinataMetadata', JSON.stringify(metadata));

    const response = await fetch(url, {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${PINATA_JWT}`
      },
      body: formData,
    });

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`Pinata upload failed: ${response.status} - ${errorText}`);
    }

    const data = await response.json();
    return data.IpfsHash;
  }

  uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const file = mediaFileInput.files[0];
    const caption = captionInput.value.trim();
    if (!file || !caption) {
      alert("Please select a file and enter a caption");
      return;
    }

    try {
      uploadForm.querySelector('button').disabled = true;
      uploadForm.querySelector('button').textContent = 'Uploading...';

      const cid = await uploadToPinata(file);
      console.log('Pinata CID:', cid);

      const fileUrl = `https://gateway.pinata.cloud/ipfs/${cid}`;
      // Save post data in Firebase DB
      await push(ref(db, 'posts'), {
        caption,
        fileUrl,
        ipfsHash: cid,
        timestamp: Date.now()
      });

      resultDiv.innerHTML = `<p>Upload successful! <a href="${fileUrl}" target="_blank">View on IPFS</a></p>`;

      // Reset form
      mediaFileInput.value = '';
      captionInput.value = '';

    } catch (error) {
      console.error('Upload error:', error);
      alert('Upload failed: ' + error.message);
    } finally {
      uploadForm.querySelector('button').disabled = false;
      uploadForm.querySelector('button').textContent = 'Upload';
    }
  });
</script>
