<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DRFMedia - Profile</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  <style>
    body { font-family: Arial; padding: 15px; background: #f8f8f8; }
    .profile-card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 0 5px #ccc; margin-bottom: 20px; }
    .profile-photo { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; }
    .post { background: white; margin: 15px 0; padding: 10px; border-radius: 8px; box-shadow: 0 0 4px #ddd; }
    .post img, .post video { width: 100%; max-height: 300px; margin-top: 10px; border-radius: 8px; }
    .edit-btn { padding: 8px 15px; background: #007bff; color: white; border: none; border-radius: 5px; }
  </style>
</head>
<body>

<div id="profile" class="profile-card">
  <center>
    <img id="profilePhoto" class="profile-photo" src="" alt="Profile Photo"/>
    <h2 id="displayName">Loading...</h2>
    <p><strong>Wallet:</strong> <span id="walletAddress">Loading...</span></p>
    <div id="editProfileSection"></div>
  </center>
</div>

<h3>User Posts</h3>
<div id="userPosts"></div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const viewingUser = urlParams.get("user");
  let currentUserEmail = null;

  if (!viewingUser) {
    alert("No user selected.");
    window.location.href = "index.html";
  }

  firebase.auth().onAuthStateChanged(async (user) => {
    if (!user) {
      alert("Login required");
      window.location.href = "index.html";
      return;
    }

    currentUserEmail = user.email;

    const db = firebase.firestore();

    // Fetch user profile
    const userDoc = await db.collection("users").doc(viewingUser).get();
    if (!userDoc.exists) {
      alert("User not found.");
      return;
    }

    const data = userDoc.data();
    document.getElementById("displayName").innerText = data.name || viewingUser;
    document.getElementById("profilePhoto").src = data.photo || "default.jpg";
    document.getElementById("walletAddress").innerText = data.wallet || "Not set";

    // Show edit button only for own profile
    if (user.uid === data.uid) {
      document.getElementById("editProfileSection").innerHTML = `
        <button class="edit-btn" onclick="editProfile()">Edit Profile</button>
      `;
    }

    // Fetch posts by user
    const postsRef = await db.collection("posts").where("owner", "==", viewingUser).orderBy("timestamp", "desc").get();

    let postsHTML = "";
    postsRef.forEach((doc) => {
      const post = doc.data();
      postsHTML += `
        <div class="post">
          <p>${post.text || ""}</p>
          ${post.image ? `<img src="${post.image}" />` : ""}
          ${post.video ? `<video controls src="${post.video}"></video>` : ""}
          <p>üëç ${post.likes || 0} | üí¨ ${post.comments?.length || 0}</p>
        </div>
      `;
    });

    document.getElementById("userPosts").innerHTML = postsHTML || "<p>No posts yet.</p>";
  });

  function editProfile() {
    window.location.href = "edit-profile.html";
  }
</script>
</body>
</html>
