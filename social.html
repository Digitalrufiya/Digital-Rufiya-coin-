<!DOCTYPE html>
<html>
<head>
  <title>DRF Social - Create Post</title>
</head>
<body>
  <h2>Post to DRF Social</h2>
  <button id="connect">Connect Wallet</button><br/><br/>

  <input type="text" id="caption" placeholder="Enter caption here" /><br/><br/>
  <input type="file" id="media" accept="image/*,video/*" /><br/><br/>

  <button id="sendPost">Upload & Post</button>
  <p id="status"></p>

  <script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.min.js"></script>
  <script>
    const CONTRACT_ADDRESS = "YOUR_DEPLOYED_CONTRACT_ADDRESS";
    const NFT_STORAGE_API_KEY = "YOUR_NFT_STORAGE_API_KEY"; // Replace with your actual API key

    const ABI = [
      "function post(string ipfsHash, string mediaType) external"
    ];

    const forbiddenWords = ["gay", "lesbian", "sex", "nude", "porn"];

    let provider, signer, contract;

    document.getElementById('connect').onclick = async () => {
      if (window.ethereum) {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
        document.getElementById('status').innerText = "Wallet connected";
      } else {
        alert("Please install MetaMask!");
      }
    };

    document.getElementById('sendPost').onclick = async () => {
      const caption = document.getElementById('caption').value.toLowerCase();
      const file = document.getElementById('media').files[0];

      if (!file) {
        alert("Please select a file.");
        return;
      }

      if (forbiddenWords.some(word => caption.includes(word))) {
        alert("Inappropriate content detected. Post blocked.");
        return;
      }

      const mediaType = file.type.startsWith('video') ? 'video' : 'image';
      document.getElementById('status').innerText = "Uploading to IPFS...";

      try {
        const res = await fetch('https://api.nft.storage/upload', {
          method: 'POST',
          headers: {
            Authorization: 'Bearer ' + NFT_STORAGE_API_KEY,
          },
          body: file
        });

        const data = await res.json();
        const ipfsHash = data.value.cid;

        document.getElementById('status').innerText = "Posting to blockchain...";

        const tx = await contract.post(ipfsHash, mediaType);
        await tx.wait();

        document.getElementById('status').innerText = "Post successfully saved on blockchain!";
      } catch (err) {
        console.error(err);
        document.getElementById('status').innerText = "Error: " + err.message;
      }
    };
  </script>
</body>
</html>
