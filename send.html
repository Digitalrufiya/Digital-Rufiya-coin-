<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Send Tokens - DRF Wallet</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Send Tokens</h1>

    <label>Select Token</label>
    <select id="tokenSelect">
      <option value="DRF">DRF</option>
      <option value="USDC">USDC</option>
      <option value="USDT">USDT</option>
    </select>

    <input type="text" id="recipient" placeholder="Receiver wallet address" />
    <input type="number" id="amount" placeholder="Amount to send" />

    <button onclick="confirmSend()">Send</button>
    <p id="status"></p>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:white; padding:20px; border-radius:10px; max-width:300px; margin:auto;">
      <h3>Confirm Transaction</h3>
      <p id="confirmText"></p>
      <button onclick="executeSend()">Confirm</button>
      <button onclick="closeModal()">Cancel</button>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <a href="dashboard.html" class="tab-item"><img src="icons/dashboard.svg" alt="Dashboard">Dashboard</a>
    <a href="send.html" class="tab-item"><img src="icons/send.svg" alt="Send">Send</a>
    <a href="swap.html" class="tab-item"><img src="icons/swap.svg" alt="Swap">Swap</a>
    <a href="transactions.html" class="tab-item"><img src="icons/tx.svg" alt="Tx">Transactions</a>
    <a href="tokensale.html" class="tab-item"><img src="icons/token.svg" alt="Token">Token Sale</a>
  </div>

  <script>
    const ADMIN_ADDRESS = "0x88253D87990EdD1E647c3B6eD21F57fb061a3040";
    const tokenContracts = {
      DRF: "0x7788a60dbC85AB46767F413EC7d51F149AA1bec6",
      USDC: "0x8ac76a51cc950d9822d68b83fe1ad97b32cd580d",
      USDT: "0x55d398326f99059ff775485246999027b3197955"
    };

    const ABI = [
      "function transfer(address to, uint amount) public returns (bool)",
      "function decimals() public view returns (uint8)"
    ];

    let token, signer, provider, decimals;
    let selectedToken, recipient, amount, feeAmount, sendAmount;

    async function confirmSend() {
      selectedToken = document.getElementById("tokenSelect").value;
      recipient = document.getElementById("recipient").value.trim();
      amount = parseFloat(document.getElementById("amount").value);

      if (!window.ethereum || !recipient || !amount) {
        alert("Please fill in all fields and connect a Web3 wallet.");
        return;
      }

      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();

      token = new ethers.Contract(tokenContracts[selectedToken], ABI, signer);
      decimals = await token.decimals();

      const fullAmount = ethers.utils.parseUnits(amount.toString(), decimals);
      feeAmount = fullAmount.mul(5).div(100); // 5% fee
      sendAmount = fullAmount.sub(feeAmount);

      document.getElementById("confirmText").innerText =
        `Send ${ethers.utils.formatUnits(sendAmount, decimals)} ${selectedToken} to ${recipient}\n` +
        `5% fee (${ethers.utils.formatUnits(feeAmount, decimals)}) will go to admin.`;

      document.getElementById("confirmModal").style.display = "flex";
    }

    async function executeSend() {
      try {
        const tx1 = await token.transfer(recipient, sendAmount);
        const tx2 = await token.transfer(ADMIN_ADDRESS, feeAmount);
        document.getElementById("status").innerText = `Success: TX1 ${tx1.hash} | TX2 ${tx2.hash}`;
        closeModal();
      } catch (e) {
        alert("Transaction failed: " + e.message);
        closeModal();
      }
    }

    function closeModal() {
      document.getElementById("confirmModal").style.display = "none";
    }
  </script>
</body>
</html>
